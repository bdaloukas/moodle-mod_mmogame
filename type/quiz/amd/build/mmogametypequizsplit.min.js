define("mmogametype_quiz/mmogametypequizsplit",["mod_mmogame/mmogamesplit"],(function(MmoGameSplit){return class extends MmoGameSplit{splits;lastUpdateTime;durationAnination=500;timeBeforeShowNextButtonCorrect=500;timeBeforeShowNextButtonError=3e3;gateOpen(mmogameid,pin,kinduser,user,modelparams){for(;this.body.firstChild;)this.body.removeChild(this.body.firstChild);let splitx=1,splity=1,isaduel=0;if(null!==modelparams){const params=JSON.parse(modelparams);void 0!==params.splitx&&params.splitx>1&&(splitx=params.splitx),void 0!==params.splity&&params.splity>1&&(splity=params.splity),void 0!==params.isaduel&&params.isaduel>1&&(isaduel=params.isaduel)}this.countX=splitx,this.countY=splity,this.countAll=this.countX*this.countY,this.isaduel=0!==isaduel,this.computeSizes(0),super.gateOpen(mmogameid,pin,kinduser,user,splitx,splity),window.addEventListener("gamepadconnected",(()=>{requestAnimationFrame((()=>this.updateGamepads()))}))}play(){this.screen=1,this.updateDelay=500,this.computeSizes(0),this.sendGetAttemptsSplit()}sendGetAttemptsSplit(){let avatarids=[];const info=this.info;this.avatarfiles=[];let splits="";for(let i=0;i<this.splits.length;i++){const sp=this.splits[i];avatarids.push(sp.avatarid),this.avatarfiles.push(info.avatars[this.gategetavatar(i,sp.avatarpos)]),i>0&&(splits+=","),splits+=i}require(["core/ajax"],(Ajax=>{let params={mmogameid:this.mmogameid,kinduser:this.kinduser,user:this.user,splits:splits,avatarids:avatarids.join(","),subcommand:""};Ajax.call([{methodname:"mmogametype_quiz_get_attempts_split",args:params}])[0].done((_ref=>{let{avatars:avatars,attempts:attempts,attemptqueryids:attemptqueryids,querydefinitions:querydefinitions,queryanswerids:queryanswerids,numattempts:numattempts,answertexts:answertexts,aduels:aduels,aduelavatars:aduelavatars,aduelcorrects:aduelcorrects,auserids:auserids,queryanswerids0:queryanswerids0,grades:grades}=_ref;this.info={avatars:avatars,attempts:attempts,paletteid:this.paletteid,attemptqueryids:attemptqueryids,numattempts:numattempts,querydefinitions:querydefinitions,queryanswerids:queryanswerids,answertexts:answertexts,aduels:aduels,aduelavatars:aduelavatars,aduelcorrects:aduelcorrects,auserids:auserids,queryanswerids0:queryanswerids0,grades:grades},void 0!==this.palette&&this.setColors(this.palette),this.createScreen()})).fail((error=>error))}))}createScreen(){for(this.screen=1,this.split.width=Math.round(document.documentElement.clientWidth/this.countX)-this.padding;this.body.firstChild;)this.body.removeChild(this.body.firstChild);const info=this.info;this.splits=[];for(let i=0;i<this.countX*this.countY&&!(i>=this.countAll);i++){const split={parent:void 0,achecked:[]};split.answers=info.answertexts,split.answerids=info.queryanswerids,split.avatarfile=info.avatars[i],split.lastUpdateTime=0,split.score=0,split.rank=0,split.rankcache="",split.isWaitingContinue=!1,split.position=this.splits.length,split.server=[],this.splits.push(split)}for(let i=0;i<this.countAll;i++)this.copySplitData(i,i);let i=0;for(let iY=0;iY<this.countY;iY++)for(let iX=0;iX<this.countX&&!(i>=this.countAll);iX++){this.createScreenSplit(i,iX,iY);const sp=this.splits[i];this.updateScore(sp),this.checkShowAduel(sp),i++}this.createScreenSave(),this.createScreenKeyboard()}createScreenSplit(split,iX,iY){const sp=this.splits[split],left=iX*(this.split.width+this.padding),top=this.split.offsetY+iY*(this.split.height+this.padding);sp.parent=this.createDOMElement("div",{parent:this.body,classnames:"mmogame-quiz-split",styles:{position:"absolute",left:`${left}px`,top:`${top}px`,width:`${this.split.width}px`,height:`${this.split.height}px`,overflow:"hidden"}});const ishorizontal=this.split.width>=this.split.height,showRank=this.isaduel||this.countX*this.countY>1;sp.player=this.createDivScorePercent(sp.parent,this.iconSize+2*this.padding,showRank),this.computeFontScorePercent(sp);let leftAvatar=Math.round(this.padding+this.iconSize/2);sp.avatar=this.createDOMElement("img",{classname:"mmogame-quiz-avatar",parent:sp.parent,styles:{position:"absolute",left:`${leftAvatar}px`,top:`${this.padding}px`,height:`${this.iconSize}px`,maxWidth:`${this.iconSize}px`,transform:"translateX(-50%)"},attributes:{src:"assets/avatars/"+sp.avatarfile,alt:this.getStringM("js_help"),role:"button"}}),sp.definitionWidth=ishorizontal?Math.round(this.split.width/2-this.padding/2):this.split.width-2*this.padding,sp.definitionHeight=ishorizontal?this.split.height-this.iconSize-2*this.padding:Math.round(this.split.height/2-2*this.padding-this.iconSize-this.iconSize/2);let definitionTop=this.iconSize+2*this.padding;sp.definition=this.createDOMElement("div",{parent:sp.parent,classnames:"mmogame-quiz-aduelsplit-definition",styles:{position:"absolute",left:`${this.padding}px`,top:`${definitionTop}px`,width:`${sp.definitionWidth}px`,height:`${sp.definitionHeight}px`,overflow:"hidden",background:this.colorDefinition,color:this.getContrastingColor(this.colorDefinition),padding:`${this.padding}px`}}),sp.definition.innerHTML=sp.attempts[0].numattempt+". "+sp.attempts[0].definition,sp.definition.addEventListener("click",(()=>{this.continueAnswer(split)}));sp.answersLeft=ishorizontal?sp.definitionWidth+2*this.padding:this.padding,sp.answersWidth=this.split.width-sp.answersLeft,sp.answersTop=ishorizontal?this.iconSize+2*this.padding:definitionTop+sp.definitionHeight+2*this.padding,sp.answersHeight=this.split.height-sp.answersTop-2*this.padding,this.createAnswerMultichoice(sp.parent,split,sp,!1),this.computeFontSize(split,sp),this.endofgame=!1}setColors(colors){super.setColors(colors),this.colorDefinition=this.getColorHex(colors[1]),this.colorScore=colors[2]}createAnswerMultichoice(parent,split,sp,disabled){const attempt=sp.attempts[0],n=attempt.answers.length;let aItemRadio=Array(n),aItemLabel=Array(n),aRandom=this.computeRandom(n);for(let i=0;i<n;i++){const ans=aRandom[i],label=this.createDOMElement("label",{parent:sp.parent,classnames:"mmogame-quiz-aduelsplit-label"+i,styles:{position:"absolute",top:`${top}px`,color:this.getContrastingColor(this.colorBackground),align:"left",marginTop:0,marginBottom:0,overflow:"visible",lineHeight:"normal"}});label.innerHTML=i+1+". "+attempt.answers[ans],label.htmlFor="mmogame_quiz_aduelsplit-input"+i;const checked=!1,item=this.createRadiobox(parent,0,this.colorBackground,this.colorScore,checked,disabled);item.style.position="absolute",item.style.left=sp.answersLeft+"px",item.id="mmogame_quiz_input"+i,item.addEventListener("click",(()=>{item.classList.contains("disabled")||(this.onClickRadio(split,i,this.colorBackground2,this.colorScore),sp.selectedAnswer=i,this.selectAnswer(split),this.updateRanks())})),label.addEventListener("click",(()=>{void 0===this.splits[split].stateShowCorrect&&(this.onClickRadio(split,i,this.colorBackground2,this.colorScore),sp.selectedAnswer=i,this.selectAnswer(split),this.updateRanks())})),aItemRadio[i]=item,aItemLabel[i]=label}return sp.aItemRadio=aItemRadio,sp.aItemLabel=aItemLabel,sp.selectedAnswer=-1,sp.aRandom=aRandom,sp.timestart=Math.round(Math.floor(Date.now()/1e3)),top}computeRandom(n){let aRandom=Array.from({length:n},((_,i)=>i));for(let i=n-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[aRandom[i],aRandom[j]]=[aRandom[j],aRandom[i]]}return aRandom}computeFontSize(split,sp){const ishorizontal=this.split.width>=this.split.height;let minSize=10;const bodyFontSize=parseFloat(getComputedStyle(document.documentElement).fontSize);let maxSize=Math.min(2*bodyFontSize,this.iconSize/2,sp.answersWidth),fontSize=minSize;const n=sp.aItemLabel.length,style=sp.definition.style,maxHeight=ishorizontal?sp.answersHeight-this.padding-this.iconSize/2:sp.answersHeight-this.iconSize-this.padding;for(style.height="auto";maxSize-minSize>.1;){fontSize=Math.round(10*(minSize+maxSize)/2)/10,style.width=sp.definitionWidth+"px",style.fontSize=fontSize+"px";let isbig=sp.definition.scrollWidth>sp.definitionWidth||sp.definition.scrollHeight>sp.definitionHeight;if(!isbig){let sum=0;const maxWidth=Math.round(sp.answersWidth-fontSize-3*this.padding);for(let i=0;i<n;i++){const elem=sp.aItemLabel[i];if(elem.style.fontSize=`${fontSize}px`,elem.style.width=maxWidth-1+"px",elem.style.height="auto",elem.scrollWidth>=maxWidth){isbig=!0;break}sum+=parseInt(elem.scrollHeight)+this.padding}sum>=maxHeight&&(isbig=!0)}isbig?maxSize=fontSize-.1:minSize=fontSize+.025}fontSize=minSize,sp.fontSize=fontSize,sp.definition.style.fontSize=fontSize+"px";let top=sp.answersTop;const leftLabel=sp.answersLeft+Math.round(fontSize)+this.padding;sp.aItemLabelTop=Array(n);for(let i=0;i<n;i++){const elem=sp.aItemLabel[i];elem.style.fontSize=`${fontSize}px`,elem.style.top=`${top}px`,elem.style.left=`${leftLabel}px`,elem.style.width=`${Math.round(sp.answersWidth-fontSize-2*this.padding)}px`,elem.style.height="auto";const radio=sp.aItemRadio[i];radio.style.width=`${Math.round(fontSize)}px`,radio.style.height=`${elem.scrollHeight}px`,radio.style.top=`${top}px`,this.drawRadio(radio,16777215,8421504),sp.aItemLabelTop[i]=top,top+=elem.scrollHeight+this.padding}const space=sp.fontSize;if(top+this.iconSize+this.padding+n*space<this.split.height){for(let i=1;i<n;i++){const elem=sp.aItemLabel[i],top=parseInt(elem.style.top)+i*sp.fontSize;elem.style.top=`${top}px`,sp.aItemRadio[i].style.top=`${top}px`}top+=(n-1)*space}return ishorizontal?sp.definition.scrollHeight<top-sp.answersTop&&(sp.definition.style.height=top-sp.answersTop+"px"):style.height=`${sp.definitionHeight}px`,fontSize}copySplitData(splitInfo,split){const sp=this.splits[split],info=this.info;let queryids=info.attemptqueryids[splitInfo].split(",");const aduelcorrects=info.aduelcorrects[splitInfo].split(","),numattempts=info.numattempts[splitInfo].split(",");sp.auserid=info.auserids[splitInfo];let attempts=info.attempts[splitInfo].split(",");sp.attempts=[],sp.score=info.grades[splitInfo];for(let i=0;i<attempts.length;i++){let item={attemptid:attempts[i]};item.queryid=queryids[i],item.definition=info.querydefinitions[item.queryid],item.answerids=info.queryanswerids[item.queryid].split(","),item.answerids0=info.queryanswerids0[item.queryid].split(","),item.answers=[],item.numattempt=numattempts[i],item.aduelcorrect=0!==parseInt(aduelcorrects[i]);for(let j=0;j<item.answerids.length;j++)item.answers.push(info.answertexts[item.answerids[j]]);sp.attempts.push(item)}sp.aduel=this.info.aduels[splitInfo],sp.aduelavatar=this.info.aduelavatars[splitInfo]}moveX(timestamp,split,num,direction,steps){0===this.screen&&super.moveX(timestamp,split,num,direction,steps)}moveY(timestamp,split,num,direction,steps){0!==this.screen?this.splits[split].isWaitingContinue||(direction<0?this.moveAnswer(timestamp,split,-1):this.moveAnswer(timestamp,split,1)):super.moveY(timestamp,split,num,direction,steps)}moveAnswer(timestamp,split,move){let sp=this.splits[split];timestamp-sp.lastUpdateTime<this.updateDelay||void 0!==sp.aItemRadio&&(sp.lastUpdateTime=timestamp,sp.selectedAnswer=-1===sp.selectedAnswer?0:(sp.aItemRadio.length+sp.selectedAnswer+move)%sp.aItemRadio.length,this.onClickRadio(split,sp.selectedAnswer,this.colorBackground2,this.colorScore))}onClickRadio(split,index,colorBack,color){let sp=this.splits[split];sp.aItemRadio[index].classList.contains("disabled")||sp.aItemRadio.forEach(((item,i)=>{const isDisabled=item.classList.contains("disabled");i===index?(item.classList.add("checked"),sp.answerid=sp.answerids[i],sp.aItemLabel[i].style.textDecoration="underline"):(item.classList.remove("checked"),sp.aItemLabel[i].style.textDecoration="none"),this.drawRadio(item,isDisabled?colorBack:16777215,color)}))}updateGamepad(timestamp,split,gamepad){super.updateGamepad(timestamp,split,gamepad);let change=!1;if(gamepad.buttons[4].value||gamepad.buttons[5].value||gamepad.buttons[6].value||gamepad.buttons[7].value||gamepad.buttons[8].value){let sp=this.splits[split];sp.isWaitingContinue&&void 0!==sp.buttonNext&&this.continueAnswer(split)}else gamepad.buttons[10].value&&this.selectAnswer(split,this.splits[split].selectedAnswer)&&(change=!0);if(change&&this.updateRanks(),void 0!==this.splits&&split<this.splits.length){const sp=this.splits[split];if(void 0!==sp.aItemLabel&&!sp.isWaitingContinue){const n=Math.min(sp.aItemLabel.length,4);for(let i=0;i<n;i++)gamepad.buttons[i].pressed&&(this.onClickRadio(split,i,this.colorBackground2,this.colorScore),sp.selectedAnswer=i,this.selectAnswer(split),this.updateRanks(),sp.isWaitingContinue=!0)}}}selectAnswer(split){let change=!1,sp=this.splits[split];if(void 0!==sp.attempts&&0!==sp.attempts.length){if(sp.selectedAnswer>=0&&!sp.isWaitingContinue){sp.isWaitingContinue=!0,change=!0;if(0===sp.aRandom[sp.selectedAnswer]){const addscore=sp.aItemRadio.length-1;sp.score+=addscore,sp.aduel>=0&&(sp.attempts[0].aduelcorrect||(sp.score+=sp.aItemRadio.length-1)),this.updateScore(sp),this.showCorrect(sp,!0,addscore,0),this.sendAnswer(split,!0)}else{let addscore=-Math.min(sp.score,1);sp.score+=addscore,this.updateScore(sp);let addscoreaduel=0;sp.aduel>=0&&sp.attempts[0].aduelcorrect&&(addscoreaduel=sp.aItemRadio.length-1,this.updateScoreOpponent(sp,addscoreaduel)),this.showCorrect(sp,!1,addscore,addscoreaduel),this.sendAnswer(split,!1)}}return change}}continueAnswer(split){const sp=this.splits[split];sp.isWaitingContinue&&(sp.isWaitingContinue=!1,sp.attempts.shift(),this.showNextQuestion(split))}updateRanks(){if(1===this.splits.length)return;for(let i=0;i<this.splits.length;i++)this.splits[i].rank=0;let rank=1;for(;;){let found=!1,max=-1;for(let i=0;i<this.splits.length;i++){const sp=this.splits[i];0===sp.rank&&(found=!0,sp.score>max&&(max=sp.score))}if(!found)break;let count=0;for(let i=0;i<this.splits.length;i++){const sp=this.splits[i];sp.score===max&&(sp.rank=rank,this.updateRank(sp),count++)}rank+=count}}updateRank(sp){1!==this.splits.length&&void 0!==sp.player&&void 0!==sp.player.lblRank&&sp.rank!==sp.rankcache&&(sp.player.lblRank.innerHTML="#"+sp.rank,sp.rankcache=sp.rank)}updateScore(sp){sp.player.lblScore.innerHTML=sp.score,this.changeScore=!0}sendAnswer(split,iscorrect){const sp=this.splits[split];if(0===sp.attempts.length)return;const attempt=sp.attempts[0],pos=sp.aRandom[sp.selectedAnswer],info={split:split,attemptid:attempt.attemptid,iscorrect:iscorrect,answer:attempt.answerids0[pos],timestart:sp.timestart,timeanswer:Math.round(Math.floor(Date.now()/1e3))};sp.server.push(info)}showCorrect(sp,iscorrect,addscore,addscoreaduel){const correctPos=sp.aRandom.indexOf(0),topCorrect=sp.aItemLabelTop[0],topIcon=topCorrect+this.padding+sp.aItemLabel[correctPos].offsetHeight,topIncorrect=topIcon+this.iconSize+this.padding,leftLabel=parseFloat(sp.aItemRadio[0].style.left);sp.stateShowCorrect=!0;for(let i=0;i<sp.aItemRadio.length;i++)this.fadeOut(sp,sp.aItemRadio[i],this.durationAnination),i!==correctPos&&i!==sp.selectedAnswer?this.fadeOut(sp,sp.aItemLabel[i],this.durationAnination):(sp.aItemRadio[i].classList.add("disabled"),sp.aItemLabel[i].classList.add("disabled"));0!==correctPos&&this.moveElementSmoothly(sp,sp.aItemLabel[correctPos],topCorrect,this.durationAnination);const sizeRadio=Math.round(sp.fontSize);if(sp.correctSmall=this.createCorrectIcon(sp,sp.parent,leftLabel,sp.aItemLabelTop[sp.selectedAnswer],topCorrect,sizeRadio,!0),iscorrect)sp.incorrectSmall=void 0;else{const label=sp.aItemLabel[sp.selectedAnswer];label.style.textDecoration="none",this.moveElementSmoothly(sp,label,topIncorrect,this.durationAnination),sp.incorrectSmall=this.createCorrectIcon(sp,sp.parent,leftLabel,sp.aItemLabelTop[sp.selectedAnswer],topIncorrect,sizeRadio,!1)}sp.timeoutStrip=setTimeout((()=>{sp.timeoutStrip=void 0,void 0!==sp.stateShowCorrect&&(this.showCorrectStrip(sp,topIcon,iscorrect,addscore,addscoreaduel),this.createNextButton(sp,correctPos,topIncorrect),sp.aItemLabel[correctPos].style.opacity="1",sp.aItemLabel[correctPos].style.display="block",sp.aItemLabel[sp.selectedAnswer].style.opacity="1",sp.aItemLabel[sp.selectedAnswer].style.display="block")}),this.durationAnination)}createCorrectIcon(sp,parent,left,topSource,topDestination,sizeRadio,iscorrect){const div=this.createDiv(parent,"mmogame-quiz-aduelsplit-iscorrect",left,topSource,sizeRadio,sizeRadio);return div.innerHTML=this.getSVGcorrect(sizeRadio,iscorrect,this.colorScore,this.colorScore),div.style.zIndex="1",topSource!==topDestination&&this.moveElementSmoothly(sp,div,topDestination,this.durationAnination),div}fadeOut(sp,element,duration){let opacity=1,interval=setInterval((function(){if(void 0===sp.stateShowCorrect)return element.style.display="block",void(element.style.opacity=1);opacity<=0?(clearInterval(interval),element.style.display="none"):(opacity-=.05,element.style.opacity=opacity)}),duration/20)}moveElementSmoothly(sp,element,finalY,duration){const startY=element.offsetTop,deltaY=finalY-startY,startTime=performance.now(),animate=()=>{if(void 0===sp.stateShowCorrect)return;const elapsedTime=performance.now()-startTime,progress=Math.min(elapsedTime/duration,1),currentY=startY+deltaY*progress;element.style.top=`${currentY}px`,progress<1?requestAnimationFrame(animate):setTimeout((function(){element.style.display="block"}),500)};animate()}getSVGcorrect(size,iscorrect,colorCorrect,colorError){if(iscorrect){return'<svg aria-hidden="true" class="svg-icon iconCheckmarkLg" width="'+size+'" height="'+size+'" viewBox="0 0 36 36"><path fill="'+(void 0!==colorCorrect?this.getColorHex(colorCorrect):"#398439")+'" d="m6 14 8 8L30 6v8L14 30l-8-8v-8z"></path></svg>'}return'<svg width="'+size+'" height="'+size+'" class="bi bi-x-lg" viewBox="0 0 18 18"> <path fill="'+(void 0!==colorError?this.getColorHex(colorError):"#398439")+'" d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 \n                1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/></svg>'}hideQuestion(sp){this.removeCorrectIcons(sp);for(let i=0;i<sp.aItemLabel.length;i++){sp.aItemLabel[i].style.display="none";sp.aItemRadio[i].style.display="none"}}showNextQuestion(split){const sp=this.splits[split];sp.isWaitingContinue=!1,sp.timestart=Math.round(Math.floor(Date.now()/1e3)),sp.stateShowCorrect=void 0,this.removeCorrectIcons(sp);const n=sp.aItemLabel.length;sp.aRandom=this.computeRandom(n);for(let i=0;i<sp.aItemLabel.length;i++){const label=sp.aItemLabel[i];label.style.top=sp.aItemLabelTop[i],label.style.display="block",label.style.opacity=1,label.style.textDecoration="none",label.classList.remove("disabled");const radio=sp.aItemRadio[i];radio.style.display="block",radio.style.opacity=1,radio.classList.remove("checked"),radio.classList.remove("disabled"),this.drawRadio(radio,16777215,this.colorScore),sp.selectedAnswer=-1}if(0===sp.attempts.length){sp.definition.innerHTML="";for(let i=0;i<sp.aItemLabel.length;i++)sp.aItemLabel[i].innerHTML="";return this.hideQuestion(sp),void this.askNextQuestions(sp)}sp.definition.innerHTML=sp.attempts[0].numattempt+". "+sp.attempts[0].definition,this.autoResizeText(sp.definition,sp.definitionWidth,sp.definitionHeight,!0,0,0);const attempt=sp.attempts[0];for(let i=0;i<sp.aItemLabel.length;i++){const ans=sp.aRandom[i];sp.aItemLabel[i].innerHTML=i+1+": "+attempt.answers[ans]}this.computeFontSize(split,sp)}askNextQuestions(sp){void 0!==sp&&void 0!==sp.aduelavatarelement&&(sp.aduelavatarelement.remove(),sp.aduelavatarelement=void 0);let splits=[],attempts=[],iscorrects=[],answers=[],timestarts=[],timeanswers=[],returnsplits=[];for(let i=0;i<this.splits.length;i++){const sp2=this.splits[i];0===sp2.attempts.length&&returnsplits.push(i);for(let j=0;j<sp2.server.length;j++){const temp=sp2.server[j];splits.push(temp.split),attempts.push(temp.attemptid),iscorrects.push(temp.iscorrect?1:0),answers.push(temp.answer),timestarts.push(temp.timestart),timeanswers.push(temp.timeanswer)}}if(0===splits.length){for(let i=0;i<this.splits.length;i++)0===this.splits[i].attempts.length&&splits.push(i);0===splits.length&&splits.push(0)}require(["core/ajax"],(Ajax=>{let params={mmogameid:this.mmogameid,kinduser:this.kinduser,user:this.user,splits:splits.join(","),attempts:attempts.join(","),iscorrects:iscorrects.join(","),answers:answers.join(","),timestarts:timestarts.join(","),timeanswers:timeanswers.join(","),returnsplits:returnsplits.join(",")};Ajax.call([{methodname:"mmogametype_quiz_send_answers_split",args:params}])[0].done((_ref2=>{let{avatars:avatars,attempts:attempts,attemptqueryids:attemptqueryids,querydefinitions:querydefinitions,queryanswerids:queryanswerids,numattempts:numattempts,answertexts:answertexts,aduels:aduels,aduelavatars:aduelavatars,aduelcorrects:aduelcorrects,auserids:auserids,queryanswerids0:queryanswerids0,grades:grades,savedattempts:savedattempts}=_ref2;this.info={avatars:avatars,attempts:attempts,paletteid:this.paletteid,attemptqueryids:attemptqueryids,numattempts:numattempts,querydefinitions:querydefinitions,queryanswerids:queryanswerids,answertexts:answertexts,aduels:aduels,aduelavatars:aduelavatars,aduelcorrects:aduelcorrects,auserids:auserids,queryanswerids0:queryanswerids0,grades:grades},this.removeFromServer(savedattempts);for(let i=0;i<returnsplits.length;i++){const split=returnsplits[i];this.copySplitData(i,split),this.checkShowAduel(this.splits[split]),this.showNextQuestion(split)}})).fail((error=>error))}))}computeFontScorePercent(sp){if(0===sp.position){const player=sp.player;player.lblScore.innerHTML="99999",this.autoResizeText(player.lblScore,this.iconSize,player.cellSize,!1,0,0);const fontSize=player.lblScore.style.fontSize,lineHeight=Math.round(parseFloat(fontSize));void 0!==player.lblRank&&(player.lblRank.style.fontSize=fontSize,player.lblRank.lineHeight=lineHeight),player.lblScore.lineHeight=lineHeight,player.lblScore.innerHTML=""}else{const player=sp.player;let fontSize=this.splits[0].player.lblRank.style.fontSize;const lineHeight=Math.round(parseFloat(fontSize));void 0!==player.lblRank&&(player.lblRank.style.fontSize=fontSize,player.lblRank.lineHeight=lineHeight),player.lblScore.style.fontSize=fontSize,player.lblScore.lineHeight=lineHeight}}removeCorrectIcons(sp){void 0!==sp.timeoutStrip&&clearTimeout(sp.timeoutStrip),void 0!==sp.stripCorrect&&(sp.stripCorrect.remove(),sp.stripCorrect=void 0),void 0!==sp.correctSmall&&(sp.correctSmall.remove(),sp.correctSmall=void 0),void 0!==sp.incorrectSmall&&(sp.incorrectSmall.remove(),sp.incorrectSmall=void 0),void 0!==sp.buttonNext&&(sp.buttonNext.remove(),sp.buttonNext=void 0)}updateScoreOpponent(sp,addscore){const avatar=sp.aduelavatar;for(let i=0;i<this.splits.length;i++)if(this.splits[i].avatarfile===avatar){const newsplit=this.splits[i];newsplit.score+=addscore,this.updateScore(newsplit);break}}checkShowAduel(sp){if(""===sp.aduelavatar||void 0===sp.aduelavatar)return void(void 0!==sp.aduelavatarelement&&(sp.aduelavatarelement.remove(),sp.aduelavatarelement=void 0));let leftAvatar=Math.round(this.padding+this.iconSize/2);sp.aduelavatarelement=this.createDOMElement("img",{classname:"mmogame-quiz-avatar",parent:sp.parent,styles:{position:"absolute",left:`${leftAvatar+2*this.iconSize+2*this.padding}px`,top:`${this.padding}px`,height:`${this.iconSize}px`,maxWidth:`${this.iconSize}px`,transform:"translateX(-50%)"},attributes:{src:"assets/avatars/"+sp.aduelavatar,alt:this.getStringM("js_help"),role:"button"}})}createAddScore(sp,left,iconSize,addscore){if(0===addscore)return;addscore>0&&(addscore="+"+addscore);const label=this.createDOMElement("div",{parent:sp.stripCorrect,classnames:"mmogame-quiz-addscore",styles:{position:"absolute",left:`${left}px`,width:`${iconSize}px`,top:"0",height:`${iconSize}px`,lineHeight:`${iconSize}px`,textAlign:"center",color:this.getContrastingColor(this.colorBackground),border:"0px solid "+this.getColorHex(this.colorBackground),boxShadow:"inset 0 0 0.125em rgba(255, 255, 255, 0.75)",background:this.getColorHex(this.colorBackground),borderRadius:`${iconSize}px`,fontSize:sp.aItemLabel[0].style.fontSize},attributes:{title:this.getStringM("js_addscore")}});return label.innerHTML=addscore,label}showCorrectStrip(sp,top,iscorrect,addscore,addscoreaduel){const iconSize=Math.max(1,Math.min(this.iconSize,Math.ceil(sp.answersWidth/4-this.padding-this.padding/4)));if(sp.stripCorrect=this.createDOMElement("div",{parent:sp.parent,classnames:"mmogame-quiz-split",styles:{position:"absolute",left:`${parseInt(sp.aItemRadio[0].style.left)}px`,top:`${top}px`,width:`${sp.answersWidth}px`,height:`${iconSize}px`,overflow:"hidden"}}),this.createAddScore(sp,0,iconSize,addscore),this.createDOMElement("img",{classname:"mmogame-quiz-avatar",parent:sp.stripCorrect,styles:{position:"absolute",left:`${iconSize+this.padding}px`,top:"0",height:`${iconSize}px`,maxWidth:`${iconSize}px`},attributes:{src:"assets/avatars/"+sp.avatarfile,alt:this.getStringM("js_help"),role:"button"}}),this.createCorrectIcon(sp,sp.stripCorrect,iconSize+this.padding,0,0,this.iconSize,iscorrect),""!==sp.aduelavatar){let leftAduel=2*(iconSize+this.padding);this.createDOMElement("img",{classname:"mmogame-quiz-avatar",parent:sp.stripCorrect,styles:{position:"absolute",left:`${leftAduel}px`,top:"0",height:`${iconSize}px`,maxWidth:`${iconSize}px`},attributes:{src:"assets/avatars/"+sp.aduelavatar,alt:this.getStringM("js_help"),role:"button"}});const correctAduel=sp.attempts[0].aduelcorrect;this.createCorrectIcon(sp,sp.stripCorrect,leftAduel,0,0,iconSize,correctAduel),this.createAddScore(sp,leftAduel+iconSize+this.padding,iconSize,addscoreaduel)}}async createNextButton(sp,correctPos,topIncorrect){const time=correctPos===sp.selectedAnswer?this.timeBeforeShowNextButtonCorrect:this.timeBeforeShowNextButtonError;sp.aItemLabel[sp.selectedAnswer].style.display="block",setTimeout((async()=>{if(sp.selectedAnswer<0||sp.selectedAnswer>=sp.aItemLabel.length)return;sp.aItemLabel[sp.selectedAnswer].style.opacity=1,sp.aItemLabel[correctPos].style.opacity=1,sp.aItemLabel[correctPos].style.display="block";const h=await this.waitForHeight(sp.aItemLabel[sp.selectedAnswer],10,30,this.iconSize),left=sp.answersLeft+Math.round(sp.answersWidth/2-this.iconSize);let top;top=correctPos===sp.selectedAnswer?sp.answersTop+h+2*this.padding+this.iconSize:topIncorrect+h+this.padding;let iconSize=this.iconSize;top+this.iconSize>this.split.height&&(iconSize=Math.round(iconSize/2),top+iconSize>this.split.height&&(top=this.split.height-iconSize)),void 0===sp.buttonNext&&(sp.buttonNext=super.createImageButton(sp.parent,"mmogame-quiz-next",left,top,0,iconSize,"assets/next.svg"),sp.buttonNext.title=this.getStringM("js_next_question"),sp.buttonNext.addEventListener("click",(()=>{this.continueAnswer(sp.position)})))}),time)}waitForHeight(el){let maxRetries=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,delay=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,fallbackHeight=arguments.length>3&&void 0!==arguments[3]?arguments[3]:24;return new Promise((resolve=>{let tries=0;!function check(){const h=el.getBoundingClientRect().height;h>0?resolve(h):(tries++,tries>=maxRetries?resolve(fallbackHeight):setTimeout(check,delay))}()}))}removeFromServer(savedattempts){for(let i=0;i<this.splits.length;i++){const sp=this.splits[i];let j=0;for(;j<sp.server.length;){const server=sp.server[j],index=savedattempts.indexOf(parseInt(server.attemptid));-1!==index?(sp.server.splice(j,1),savedattempts.splice(index,1)):j++}}}createScreenSave(){const size=Math.round(this.iconSize/2);this.createDOMElement("img",{classname:"mmogame-quiz-save",parent:this.body,styles:{position:"absolute",left:window.innerWidth-this.iconSize+"px",top:`${this.padding}px`,height:`${size}px`,maxWidth:`${size}px`,transform:"translateX(-50%)"},attributes:{src:"assets/save.svg",alt:this.getStringM("js_help"),role:"button"}}).addEventListener("click",(()=>{this.save()}))}save(){this.askNextQuestions(void 0)}createScreenKeyboard(){let instance=this;document.addEventListener("keydown",(function(event){if(["1","2","3","4","5","6","7","8","9"].includes(event.key)){let split=-1;switch(event.location){case KeyboardEvent.DOM_KEY_LOCATION_NUMPAD:split=1;break;case KeyboardEvent.DOM_KEY_LOCATION_STANDARD:split=0}if(split>=0&&split<=instance.splits.length){const sp=instance.splits[split];if(!sp.isWaitingContinue){const i=parseInt(event.key)-1;i<sp.aItemLabel.length&&(instance.onClickRadio(split,i,instance.colorBackground2,instance.colorScore),sp.selectedAnswer=i,instance.selectAnswer(split),instance.updateRanks(),sp.isWaitingContinue=!0)}}}if("Enter"===event.key){let split=-1;switch(event.location){case KeyboardEvent.DOM_KEY_LOCATION_STANDARD:split=0;break;case KeyboardEvent.DOM_KEY_LOCATION_NUMPAD:split=1}if(split>=0&&split<instance.splits.length){const sp=instance.splits[split];sp.isWaitingContinue&&void 0!==sp.buttonNext&&instance.continueAnswer(split)}}}))}}}));

//# sourceMappingURL=mmogametypequizsplit.min.js.map