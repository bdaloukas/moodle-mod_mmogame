define("mod_mmogame/mmogamesplit",["mod_mmogame/mmogame",""],(function(MmoGame){return class extends MmoGame{updateDelay=200;countX;countY;countAll;screen;gateShowColorPalettes(parent,countY,colorpaletteids,colorpalettes){const left=this.padding,topButton=this.iconSize+2*this.padding+Math.round(this.fontSize),restHeight=window.innerHeight-topButton-countY*(this.iconSize+this.padding),top=topButton+Math.round(restHeight/2);let i=0;const count=colorpalettes.length;this.canvasColor=void 0;const canvasSize=this.iconSize-3*this.padding/2,parsedPalettes=colorpalettes.map((palette=>palette.split(",").map((value=>parseInt(value,10)||0))));let acanvas=[];const fragment=document.createDocumentFragment();for(let iy=0;iy<countY;iy++)for(let ix=0;ix<1;ix++){if(i>=count||!parsedPalettes[i]||!colorpaletteids[i]){i++;continue}let canvas=document.createElement("canvas");canvas.style.position="absolute",canvas.style.left=`${left+ix*(this.iconSize+this.padding)}px`,canvas.style.top=`${top+iy*(this.iconSize+this.padding)}px`,canvas.width=canvasSize,canvas.height=canvasSize,canvas.style.cursor="pointer",canvas.classList.add("mmogame_color"),acanvas.push(canvas),fragment.appendChild(canvas);const palette=parsedPalettes[i];this.showColorPalette(canvas,palette);let id=colorpaletteids[i];canvas.addEventListener("click",(()=>{this.gateUpdateColorPalette(canvas,id,palette)})),i++}return parent.appendChild(fragment),acanvas}gateUpdateColorPalette(canvas,id,palette){void 0!==this.canvasColor&&(this.canvasColor.style.borderStyle="none"),this.canvasColor=canvas;let w=Math.round(this.padding)+"px";Object.assign(canvas.style,{borderStyle:"outset",borderLeftWidth:w,borderTopWidth:w,borderRightWidth:w,borderBottomWidth:w}),this.paletteid=id,this.palette=palette}gateUpdateAvatar(split,avatar,id){const sp=this.splits[split];void 0!==sp.avatar&&(sp.avatar.style.borderStyle="none"),sp.avatar=avatar,avatar.style.borderStyle="outset";const w=Math.round(this.padding)+"px";avatar.style.borderLeftWidth=w,avatar.style.borderTopWidth=w,avatar.style.borderRightWidth=w,avatar.style.borderBottomWidth=w,sp.avatarid=id}updateGamepads(timestamp){const gamepads=navigator.getGamepads();void 0!==this.gateInfo&&(this.gateInfo.textContent=Array.from(navigator.getGamepads()).filter((gp=>null!==gp)).length);const n=void 0!==this.splits?this.splits.length:0;for(let i=0;i<gamepads.length;i++)gamepads[i]&&i<n&&this.updateGamepad(timestamp,i,gamepads[i]);this.updateScreen()}computeSizes(offsetY){const maxIconWidth=Math.floor(window.innerWidth/(3*this.countX+1.2+this.countX/10)),maxIconHeight=Math.floor(window.innerHeight/(this.countY+.5)),bodyFontSize=parseFloat(getComputedStyle(document.documentElement).fontSize);this.iconSize=Math.min(maxIconWidth,maxIconHeight,4*bodyFontSize),this.padding=Math.round(this.iconSize/10),this.iconSize-=this.padding,this.split={offsetY:offsetY*this.iconSize,width:Math.round((window.innerWidth-this.iconSize-3*this.padding)/this.countX),height:Math.round((window.innerHeight-offsetY*this.iconSize)/this.countY-this.padding)},this.createArea(0,0),this.countXavatars=Math.floor((this.split.width-this.padding)/(this.iconSize+this.padding)),this.countYavatars=Math.floor((this.split.height-2*this.padding)/(this.iconSize+this.padding)),this.countPalettes=Math.floor((window.innerHeight-3*this.padding)/(this.iconSize+this.padding))-1;const widthSplits=this.countX*(this.split.width+this.padding)+this.padding,space=window.innerWidth-widthSplits-this.iconSize-2*this.padding;this.split.offsetX=Math.round(this.iconSize+this.padding+space/2);this.countXavatars*this.countYavatars>66&&(this.countXavatars<this.countYavatars?this.countYavatars=Math.floor(66/this.countXavatars):this.countXavatars=Math.floor(66/this.countYavatars))}gateCreateScreen(){this.cIcons=5,this.gateCreateSidebar(),this.gateShowColorPalettes(this.body,this.countPalettes,this.info.colorpaletteids,this.info.colorpalettes),this.splits=[];for(let iY=0;iY<this.countY;iY++)for(let iX=0;iX<this.countX&&!(this.splits.length>=this.countAll);iX++)this.gateCreateScreenSplit(iX,iY),this.gateCreateScreenSplitSelect()}gateCreateScreenSplit(iX,iY){let parent=this.createDOMElement("div",{parent:this.area,classnames:"mmogame-split",styles:{position:"absolute",left:`${this.split.offsetX+iX*(this.split.width+this.padding)}px`,top:`${iY*(this.split.height+this.padding)+this.padding}px`,width:`${this.split.width}px`,height:`${this.split.height}px`,overflow:"hidden",border:"1px solid blue"}});const labelHeight=this.countX*this.countY>1?Math.round(this.iconSize/3):0,sizeAvatars=this.countYavatars*(this.iconSize+this.padding),restHeight=this.split.height-labelHeight-2*this.padding-sizeAvatars;let top=labelHeight+this.padding+Math.round(restHeight/2);const topLabel=Math.round((top-labelHeight)/2);let avatarbuttons=[],pos=(iX+this.countX*iY)*this.countYavatars*this.countXavatars;for(let i=0;i<this.countYavatars;i++){for(let j=0;j<this.countXavatars&&!(pos>=this.info.avatars.length);j++){const filepath=this.info.avatars[pos],filename=filepath.split("/").pop().split(".").slice(0,-1).join("."),btn=this.createDOMElement("img",{parent:parent,classnames:"mmogame-button-help",styles:{position:"absolute",left:`${this.padding+j*(this.iconSize+this.padding)}px`,top:`${top}px`,width:`${this.iconSize}px`,height:`${this.iconSize}px`},attributes:{src:"assets/avatars/"+filepath,alt:filename,role:"button"}}),avatarid=this.info.avatarids[pos],posAvatar=pos,split=this.splits.length;btn.addEventListener("click",(()=>{this.splits[split].avatarpos=posAvatar,this.gateUpdateAvatar(split,btn,avatarid)})),avatarbuttons.push(btn),pos++}top+=this.iconSize+this.padding}let labelAvatar=this.createDOMElement("label",{parent:parent,classnames:"mmogame-gate-avatar-label",styles:{position:"absolute",font:"FontAwesome",fontSize:`${labelHeight}px`,lineHeight:`${labelHeight}px`,width:"0px",height:`${labelHeight}px`,whiteSpace:"nowrap",color:this.getContrastingColor(this.colorBackground),top:`${topLabel}px`,left:`${this.padding}px`}});this.countX*this.countY>1&&(labelAvatar.innerHTML=iX+this.countX*iY+1),this.splits.push({div:parent,avatarpos:-1,avatarid:null,avatarbuttons:avatarbuttons,labelAvatar:labelAvatar,lastUpdateTime:0})}gategetavatar(split,i){return split*this.info.numavatars+i}gateCreateScreenSplitSelect(){const split=this.splits.length-1,sp=this.splits[split];let id,selected=0;for(;;){id=this.info.avatarids[this.gategetavatar(split,selected)];let found=!1;for(let i=0;i<split-1;i++){const avatarpos=this.splits[i].avatarpos;if(this.info.avatarids[this.gategetavatar(i,avatarpos)]===id){found=!0;break}}if(!found)break;selected++}sp.avatarpos=selected,this.gateUpdateAvatar(split,sp.avatarbuttons[sp.avatarpos],id)}updateScreen(){requestAnimationFrame((t=>this.updateGamepads(t)))}createDivScorePercent(parent,left,showRank){const colorText=this.getContrastingColor(this.colorBackground),divMain=this.createDOMElement("div",{parent:parent,classnames:"mmogame-quiz-main",styles:{position:"absolute",left:`${left}px`,top:`${this.padding}px`,width:`${this.iconSize}px`,height:`${this.iconSize}px`,border:"0px solid "+this.getColorHex(this.colorBackground),boxShadow:"inset 0 0 0.125em rgba(255, 255, 255, 0.75)",background:this.getColorHex(this.colorBackground),color:colorText,borderRadius:`${this.iconSize}px`},attributes:{disabled:!0,innerHTML:""}}),cellSize=showRank?Math.round(this.iconSize/2):this.iconSize;let lblRank;showRank&&(lblRank=this.createDOMElement("div",{parent:parent,classnames:"mmogame-pwn-rank",styles:{position:"absolute",left:`${left}px`,width:`${this.iconSize}px`,top:`${this.padding}px`,height:`${cellSize}px`,lineHeight:`${cellSize}px`,textAlign:"center",color:colorText},attributes:{title:this.getStringM("js_ranking")}}));return{divMain:divMain,lblRank:lblRank,lblScore:this.createDOMElement("div",{parent:parent,classnames:"mmogame-score",styles:{position:"absolute",left:`${left}px`,width:`${this.iconSize}px`,top:`${showRank?this.padding+cellSize:this.padding}px`,height:`${cellSize}px`,lineHeight:`${cellSize}px`,textAlign:"center",color:colorText},attributes:{title:this.getStringM("js_grade")}}),cellSize:cellSize}}moveX(timestamp,split,num,direction,steps){if(split>=this.splits.length)return;let sp=this.splits[split];if(sp.lastUpdateTime>0&&timestamp-sp.lastUpdateTime<this.updateDelay)return;if(sp.lastUpdateTime=timestamp,split>=this.splits.length)return;this.usersecondjoystick=!1,split=(this.usersecondjoystick?2:1)*split+(num-1);const n=this.countXavatars*this.countYavatars;let id,pos=this.splits[split].avatarpos;for(;;){pos=(pos+direction*steps+n)%n,id=this.info.avatarids[this.gategetavatar(split,pos)];let found=!1;for(let i=0;i<this.splits.length;i++){if(i===split)continue;this.splits[i].avatarid===id&&(found=!0)}if(!1===found){this.splits[split].avatarpos=pos,this.splits[split].avatarid=id;break}}this.gateUpdateAvatar(split,this.splits[split].avatarbuttons[pos],id)}moveY(timestamp,split,num,direction,steps){this.moveX(timestamp,split,num,direction,steps*this.countXavatars)}updateGamepad(timestamp,split,gamepad){const axes=gamepad.axes,axisX1=(null==axes?void 0:axes[0])??0,axisY1=(null==axes?void 0:axes[1])??0;axisX1<-.5&&this.moveX(timestamp,split,1,-1,1),axisX1>.5&&this.moveX(timestamp,split,1,1,1),axisY1<-.5&&this.moveY(timestamp,split,1,-1,1),axisY1>.5&&this.moveY(timestamp,split,1,1,1)}gateCreateSidebar(){this.createDOMElement("img",{parent:this.body,classnames:"mmogame-button-run",styles:{position:"absolute",left:`${this.padding}px`,top:`${this.padding}px`,width:`${this.iconSize}px`,height:`${this.iconSize}px`},attributes:{src:"assets/start.svg",alt:"start",role:"button"}}).addEventListener("click",(()=>{this.play()})),this.gateInfo=this.createDOMElement("div",{parent:this.body,classnames:"mmogame-split-info",styles:{position:"absolute",left:"0",top:`${this.iconSize+2*this.padding}px`,width:`${this.iconSize}px`,height:`${this.iconSize}px`,textAlign:"right",color:this.getContrastingColor(this.colorBackground)}});const sel=this.createDOMElement("select",{parent:this.body,classnames:"mmogame-select-split",styles:{position:"absolute",left:`${this.padding}px`,top:`${this.iconSize+2*this.padding}px`,textAlign:"left"}});for(let i=1;i<=8;i++){const option=document.createElement("option");option.value=i,option.text=i,i-this.countAll==0&&(option.selected=!0),sel.appendChild(option)}sel.addEventListener("change",(()=>{for(this.countAll=sel.value,this.countY=Math.round(Math.sqrt(this.countAll)),this.countX=Math.ceil(this.countAll/this.countY);this.body.firstChild;)this.body.removeChild(this.body.firstChild);this.area=void 0,this.computeSizes(0),this.gateSendGetAssets()}))}gateSendGetAssets(){require(["core/ajax"],(Ajax=>{let params={mmogameid:this.mmogameid,kinduser:this.kinduser,user:this.user,countsplit:this.countAll,countpalettes:this.countPalettes,countavatars:this.countXavatars*this.countYavatars};Ajax.call([{methodname:"mod_mmogame_get_assets_split",args:params}])[0].done((_ref=>{let{avatarids:avatarids,avatars:avatars,colorpaletteids:colorpaletteids,colorpalettes:colorpalettes,numavatars:numavatars}=_ref;this.info={avatarids:avatarids,avatars:avatars,colorpaletteids:colorpaletteids,colorpalettes:colorpalettes,numavatars:numavatars},this.gateCreateScreen()})).fail((error=>(this.showError("gateSendGetAssets",error),error)))}))}async gateOpen(mmogameid,pin,kinduser,user){if(this.mmogameid=mmogameid,this.pin=pin,this.kinduser=kinduser,this.screen=0,"guid"===this.kinduser){const option=await this.getOption("guid"+mmogameid);null===option?(this.user=crypto.randomUUID(),this.setOption("guid"+mmogameid,{value:this.user})):this.user=option.value}else this.kinduser=user;console.log("this.gateSendGetAssets"),this.gateSendGetAssets()}}}));

//# sourceMappingURL=mmogamesplit.min.js.map