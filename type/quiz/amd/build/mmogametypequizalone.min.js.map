{"version":3,"file":"mmogametypequizalone.min.js","sources":["../src/mmogametypequizalone.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\ndefine(['mmogametype_quiz/mmogametypequiz'],\n    function(MmoGameTypeQuiz) {\n    return class MmoGameTypeQuizAlone extends MmoGameTypeQuiz {\n\n        // Score variables.\n        player;\n\n        constructor() {\n            super();\n            this.cIcons = this.hasHelp() ? 5 : 4;\n            this.type = 'alone';\n        }\n\n        createIconBar() {\n            let i = 0;\n            const step = this.iconSize + this.padding;\n\n            const nicknameHeight = Math.round(this.iconSize / 3);\n\n            const fragment = document.createDocumentFragment(); // Batch DOM updates\n\n            const [nickname, avatar] = this.createNicknameAvatar(fragment,\n                'mmogame-quiz-alone',\n                Math.round(this.padding + (i++) * step),\n                this.padding,\n                2 * this.iconSize + this.padding,\n                nicknameHeight,\n                this.padding + nicknameHeight,\n                this.iconSize);\n\n            this.player = this.createDivScorePercent(fragment,\n                'mmogame-quiz-alone',\n                this.padding + (i++) * step,\n                this.padding + nicknameHeight,\n                true,\n                this.colorScore);\n            this.player.avatarElement = avatar;\n            this.player.nicknameElement = nickname;\n            this.player.cacheAvatar = '';\n            this.player.cacheNickname = '';\n            this.player.lblScore.title = this.getStringM('js_grade');\n            this.player.lblRank.title = this.getStringM('js_ranking_grade');\n\n            this.createButtonSound(fragment, this.padding + (i++) * step,\n                this.padding + nicknameHeight, this.iconSize);\n            if (this.hasHelp()) {\n                const button = this.createButtonHelp(fragment, this.padding + (i++) * step, this.padding);\n                button.addEventListener(\"click\", () => this.onClickHelp());\n            }\n            this.createArea(2 * this.padding + this.iconSize + nicknameHeight);\n\n            this.body.appendChild(fragment); // Batch insert into DOM\n        }\n\n        processSetAnswer(json) {\n            this.correct = json.correct;\n\n            this.playAudio(json.iscorrect !== 0 ? this.audioYes : this.audioNo);\n\n            if (json.correct !== undefined && this.qtype === \"multichoice\") {\n                this.updateScreenAfterAnswerMultichoice();\n            }\n\n            this.disableInput();\n\n            const btn = super.createImageButton(\n                this.area,\n                'mmogame-quiz-next',\n                this.nextLeft,\n                this.nextTop,\n                0,\n                this.iconSize,\n                'assets/next.svg'\n            );\n            btn.addEventListener(\"click\", () => {\n                this.callGetAttempt();\n                this.area.removeChild(btn);\n            });\n\n            this.showScore(json);\n        }\n\n        onServerFastJson(response) {\n            const [state, timefastjson] = response.split(\"-\").map(Number);\n            if (timefastjson !== this.timefastjson || state !== this.state) {\n                this.callGetAttempt();\n                return;\n            }\n\n            this.sendFastJSON();\n        }\n\n        /**\n         * Creates the game screen layout based on the current state.\n         *\n         * @param {Object} json - The game data used to build the screen.\n         * @param {boolean} disabled - Determines whether user input should be disabled.\n         */\n        createScreen(json, disabled) {\n            if (this.endofgame) {\n                // Display end-of-game message and final score\n                this.createDivMessage('mmogame-endofgame', this.getStringM('js_game_over'));\n                this.showScore(json);\n                return;\n            }\n\n            // Render the screen layout based on orientation (vertical or horizontal)\n            if (this.isVertical) {\n                this.createScreenVertical(json, disabled);\n            } else {\n                this.createScreenHorizontal(json, disabled);\n            }\n\n            // Display the current score\n            this.showScore(json);\n        }\n\n        /**\n         * Creates a horizontal layout for the quiz screen.\n         *\n         * @param {object} json\n         * @param {boolean} disabled - Whether user input should be disabled.\n         */\n        createScreenHorizontal(json, disabled) {\n            // Reserve space for next button\n            let maxHeight = this.areaRect.height - 2 * this.padding - this.iconSize;\n\n            const width = Math.round((this.areaRect.width - this.padding) / 2 - this.padding);\n            for (let step = 1; step <= 2; step++) {\n                let defSize;\n                this.fontSize = this.findbest(step === 1 ? this.minFontSize : this.minFontSize / 2, this.maxFontSize,\n                    (fontSize) => {\n                        defSize = this.createDefinition(0, 0, width - this.padding, 0, true, fontSize,\n                            json.definition);\n\n                        if (defSize[0] >= width) {\n                            return 1;\n                        }\n                        let ansSize = this.createAnswer(0, 0, width - this.padding, true, fontSize, disabled);\n                        if (ansSize[0] >= width) {\n                            return 1;\n                        }\n                        return defSize[1] < maxHeight && ansSize[1] < maxHeight ? -1 : 1;\n                    }\n                );\n                if (defSize[0] <= width && defSize[1] <= maxHeight) {\n                    break;\n                }\n            }\n\n            this.radioSize = Math.round(this.fontSize);\n            const heightAnswer = this.createAnswer(width, 0, width - this.padding, false, this.fontSize, disabled);\n\n            this.createDefinition(0, 0, width - this.padding, heightAnswer, false, this.fontSize, json.definition);\n\n            this.nextTop = heightAnswer + this.padding;\n\n            // Adjust strip dimensions\n            this.stripLeft = width + this.padding;\n            this.stripWidth = 2 * this.iconSize;\n            this.stripHeight = this.iconSize;\n        }\n\n        createScreenVertical(json, disabled) {\n            let maxHeight = this.areaRect.height - 2 * this.padding - this.iconSize;\n\n            for (let step = 1; step <= 2; step++) {\n                let defSize, ansSize;\n                this.fontSize = this.findbest(step === 1 ? this.minFontSize : this.minFontSize / 2, this.maxFontSize,\n                    (fontSize) => {\n                        defSize = this.createDefinition(0, 0, this.areaRect.width, 0, true, fontSize,\n                            json.definition);\n                        ansSize = this.createAnswer(0, 0, this.areaRect.width, true, fontSize, disabled);\n\n                        if (defSize[0] >= this.areaRect.width || ansSize[0] >= this.areaRect.width) {\n                            return 1;\n                        }\n                        return defSize[1] + ansSize[1] < maxHeight ? -1 : 1;\n                    }\n                );\n                if (defSize[0] <= this.areaRect.width && defSize[1] + ansSize[1] <= maxHeight) {\n                    break;\n                }\n            }\n\n            this.radioSize = Math.round(this.fontSize);\n            const defSize = this.createDefinition(0, 0, this.areaRect.width, 0, false, this.fontSize, json.definition);\n\n            this.nextTop = this.createAnswer(\n                0, defSize[1] + this.padding, this.areaRect.width, false, this.fontSize, disabled) + this.padding;\n\n            // Adjust strip dimensions\n            this.stripLeft = this.iconSize + this.padding;\n            this.stripWidth = 2 * this.iconSize;\n            this.stripHeight = this.iconSize;\n        }\n\n        processGetAttempt(json) {\n            // Calculate time difference and set up the clock\n            this.computeDifClock(json.time, json.timestart, json.timeclose);\n\n            if (parseInt(json.state) === 0) {\n                json.qtype = '';\n                if (json.colors) {\n                    this.setColorsString(json.colors);\n                    this.createIconBar();\n                }\n                this.showScore(json);\n                this.createDivMessageStart(this.getStringM('js_wait_to_start'));\n                return;\n            }\n\n            if (this.player === undefined) {\n                this.setColorsString(json.colors);\n                this.createIconBar();\n            }\n\n            // Update the window title if a name is provided\n            if (json.name) {\n                document.title = json.name;\n            }\n\n            // Handle error messages from the server\n            if (json.errorcode) {\n                this.createDivMessage('mmogame-error', json.errorcode);\n                return;\n            }\n\n            // Update game state and user-related data\n            this.state = parseInt(json.state, 10);\n            this.fastjson = json.fastjson;\n            this.timefastjson = parseInt(json.timefastjson, 10);\n\n            const nicknameWidth = 2 * this.iconSize + this.padding;\n            const nicknameHeight = this.iconSize / 3;\n            this.updateNicknameAvatar(this.player, json.avatar, json.nickname, nicknameWidth, nicknameHeight);\n            this.attempt = json.attempt;\n\n            // Process question type and answers\n            this.qtype = json.qtype;\n            if (this.qtype === 'multichoice') {\n                this.answers = [];\n                this.answersID = json.answerids;\n                json.answers.forEach((answer, index) => {\n                    this.answers[index] = this.repairP(answer); // Process each answer\n                });\n            }\n            this.answer = json.answer ?? undefined;\n\n            // Handle end-of-game scenarios\n            this.endofgame = json.endofgame !== undefined && json.endofgame !== 0;\n            json.definition = this.repairP(json.definition);\n            this.errorcode = json.errorcode;\n\n            if (json.state !== 0) {\n                this.createScreen(json, false);\n            }\n\n            // A this.updateLabelTimer(); // Start or update the timer\n            this.sendFastJSON(); // Send fast JSON updates\n        }\n\n        showScore({sumscore, rank, percent, percentrank}) {\n            super.showScore(this.player, sumscore, rank, percent, percentrank, true);\n        }\n\n        showHelpScreen(div) {\n            div.innerHTML = `\n                <br>\n                <div>${this.getStringT('js_alone_help')}</div><br>\n\n                <table class=\"mmogame-table-help\">\n                    <tr>\n                        <td><img height=\"83\" src=\"assets/aduel/example2.png\" alt=\"\" /></td>\n                        <td>${this.getStringT('js_aduel_example2')}</td>\n                    </tr>\n                </table>\n            `;\n        }\n    };\n});"],"names":["define","MmoGameTypeQuiz","player","constructor","super","this","cIcons","hasHelp","type","createIconBar","i","step","iconSize","padding","nicknameHeight","Math","round","fragment","document","createDocumentFragment","nickname","avatar","createNicknameAvatar","createDivScorePercent","colorScore","avatarElement","nicknameElement","cacheAvatar","cacheNickname","lblScore","title","getStringM","lblRank","createButtonSound","createButtonHelp","addEventListener","onClickHelp","createArea","body","appendChild","processSetAnswer","json","correct","playAudio","iscorrect","audioYes","audioNo","undefined","qtype","updateScreenAfterAnswerMultichoice","disableInput","btn","createImageButton","area","nextLeft","nextTop","callGetAttempt","removeChild","showScore","onServerFastJson","response","state","timefastjson","split","map","Number","sendFastJSON","createScreen","disabled","endofgame","createDivMessage","isVertical","createScreenVertical","createScreenHorizontal","maxHeight","areaRect","height","width","defSize","fontSize","findbest","minFontSize","maxFontSize","createDefinition","definition","ansSize","createAnswer","radioSize","heightAnswer","stripLeft","stripWidth","stripHeight","processGetAttempt","computeDifClock","time","timestart","timeclose","parseInt","colors","setColorsString","createDivMessageStart","name","errorcode","fastjson","nicknameWidth","updateNicknameAvatar","attempt","answers","answersID","answerids","forEach","answer","index","repairP","_ref","sumscore","rank","percent","percentrank","showHelpScreen","div","innerHTML","getStringT"],"mappings":"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"}