function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}define("mod_mmogame/mmogame",[""],(function(){return class{
/**
     * Initialize game properties and compute initial sizes.
     *
     * @module mmogame
     * @copyright 2024 Vasilis Daloukas
     * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
     */
constructor(){_defineProperty(this,"state",void 0),_defineProperty(this,"body",void 0),_defineProperty(this,"minFontSize",void 0),_defineProperty(this,"maxFontSize",void 0),_defineProperty(this,"fontSize",void 0),_defineProperty(this,"avatarTop",void 0),_defineProperty(this,"colors",{}),_defineProperty(this,"iconSize",void 0),_defineProperty(this,"padding",void 0),_defineProperty(this,"cIcons",void 0),_defineProperty(this,"area",void 0),_defineProperty(this,"colorsBackground",void 0),_defineProperty(this,"timestart",0),_defineProperty(this,"timeclose",0),this.kindSound=0,this.state=0,this.minFontSize=0,this.maxFontSize=0,this.fontSize=0,this.avatarTop=0,this.iconSize=0,this.padding=0,this.body=document.getElementsByTagName("body")[0];let size=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("font-size"));this.minFontSize=size,this.maxFontSize=2*size,this.fontSize=size}createDOMElement(tag){let{parent:parent,classnames:classnames="",styles:styles={},attributes:attributes={}}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const element=document.createElement(tag);return classnames&&element.classList.add(...classnames.split(/\s+/)),Object.assign(element.style,styles),Object.entries(attributes).forEach((_ref=>{let[key,value]=_ref;null!=value&&element.setAttribute(key,value)})),parent&&parent.appendChild(element),element}createDiv(parent,classnames,left,top,width,height){return this.createDOMElement("div",{parent:parent,classnames:classnames,styles:{position:"absolute",left:"".concat(left,"px"),top:"".concat(top,"px"),width:"".concat(width,"px"),height:"".concat(height,"px")}})}createImage(parent,classnames,left,top,width,height,filename){const styles={position:"absolute",left:"".concat(left,"px"),top:"".concat(top,"px")};0!==width&&(styles.width="".concat(width,"px")),0!==height&&(styles.height="".concat(height,"px"));const attributes={draggable:!1};return""!==filename&&(attributes.src=filename),this.createDOMElement("img",{parent:parent,classnames:classnames,styles:styles,attributes:attributes})}createButton(parent,classnames,left,top,width,height,src,alt){let role=arguments.length>8&&void 0!==arguments[8]?arguments[8]:"button";return this.createDOMElement("img",{parent:parent,classnames:classnames,styles:{position:"absolute",left:"".concat(left,"px"),top:"".concat(top,"px"),width:"".concat(width,"px"),height:"".concat(height,"px")},attributes:{src:src,alt:alt,role:role}})}createTextElement(parent,type,classnames,styles){let text=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";const attributes="input"===type?{type:"text",placeholder:text}:{},element=this.createDOMElement(type,{parent:parent,classnames:classnames,styles:styles,attributes:attributes});return"label"===type&&(element.innerText=text),element}createLabel(parent,classnames,left,top,width,fontSize,text){return this.createTextElement(parent,"label",classnames,{position:"absolute",left:"".concat(left,"px"),top:"".concat(top,"px"),width:"".concat(width,"px"),fontSize:"".concat(fontSize,"px"),textAlign:"left"},text)}createInput(parent,classnames,left,top,width,fontSize,placeholder){return this.createTextElement(parent,"input",classnames,{position:"absolute",left:"".concat(left,"px"),top:"".concat(top,"px"),width:"".concat(width,"px"),fontSize:"".concat(fontSize,"px")},placeholder)}computeSizes(){const cIcons=Math.max(this.cIcons||5,5),maxIconWidth=window.innerWidth/cIcons,maxIconHeight=window.innerHeight/5;this.iconSize=Math.min(maxIconWidth,maxIconHeight);const adjustment=this.iconSize/10/cIcons;this.iconSize=Math.round(this.iconSize-adjustment),this.padding=Math.round(this.iconSize/10),this.iconSize-=this.padding}createCenterImageButton(parent,left,top,width,height,classname,filename){const button=this.createDOMElement("img",{parent:parent,classnames:"mmogame_imgbutton ".concat(classname),styles:{position:"absolute",draggable:!1}}),img=new Image;return img.onload=function(){if(this.width>0&&this.height>0){const mul=Math.min(width/this.width,height/this.height),w=Math.round(this.width*mul),h=Math.round(this.height*mul);Object.assign(button.style,{width:"".concat(w,"px"),height:"".concat(h,"px"),left:"".concat(left+width/2-w/2,"px"),top:"".concat(top+height/2-h/2,"px")}),button.src=filename}},img.src=filename,button}createDivButton(classnames,left,top){return this.createButton(this.body,classnames,left,top,this.iconSize,this.iconSize,"","","button")}hasHelp(){return!1}clearBodyChildren(){for(this.removeDivMessage();this.body.firstChild;)this.body.removeChild(this.body.firstChild);this.area=void 0}openGame(){this.clearBodyChildren(),this.computeSizes()}updateImageButton(button,src){button.src=src}autoResizeText(item,width,height,wrap,minFontSize,maxFontSize,minRatio){const text=item.innerHTML.toString();if(0===text.length)return!1;let low=Math.max(1,minFontSize);width=Math.round(width),height=Math.round(height);let up=0===maxFontSize||void 0===maxFontSize?Math.min(width,height):maxFontSize,fitSize=low,fitHeight=0,newHeight=0,newWidth=0,i=1;for(;i<=10;i++){let el=document.createElement("div");el.style.left=0,el.style.top=0,el.style.width=width+"px",el.style.height=0,el.visibility="visible",wrap||(el.style.whiteSpace="nowrap"),el.innerHTML=text,this.body.appendChild(el);let fontSize=(low+up)/2;if(el.style.fontSize=fontSize+"px",newHeight=el.scrollHeight,newWidth=el.scrollWidth-1,this.body.removeChild(el),newWidth>width||newHeight>height)up=fontSize;else{if(low=fontSize,Math.abs(fitHeight-newHeight)<=2)break;fitHeight=newHeight,fitSize=fontSize}}if(item.style.fontSize=fitSize+"px",!(newWidth>width||newHeight>height))return[item.scrollWidth-1,item.scrollHeight];this.autoResizeTextBr(item),newWidth=item.scrollWidth,newHeight=item.scrollHeight,this.autoResizeTextImage(item,newWidth>width?newWidth-width:0,newHeight>height?newHeight-height:0,minRatio);let el=document.createElement("div");el.style.width=width+"px",el.style.height=0,el.visibility="hidden",wrap||(el.style.whiteSpace="nowrap"),el.innerHTML=text,this.body.appendChild(el),el.style.fontSize=item.style.fontSize;let size=[el.scrollWidth-1,el.scrollHeight];return this.body.removeChild(el),size}autoResizeTextBr(item){let s=item.innerHTML,change=!1;for(;s.startsWith("<br>");)s=s.substring(4),change=!0;let pos1=s.indexOf("<br>");for(;;){let pos=s.indexOf("<br>",pos1+4);if(pos<0)break;s.substring(pos1+4,pos).trim()||(s=s.substring(0,pos1+4)+s.substring(pos+4),change=!0,pos=pos1),pos1=pos}change&&(item.innerHTML=s)}autoResizeTextImage(item,subwidth,subheight,minRatio){if(0===subwidth&&0===subheight)return;let s=item.innerHTML;for(let pos=0;;){let pos2=s.indexOf("<img ",pos);if(pos2<0)break;let pos3=s.indexOf(">",pos2);if(pos3<0)break;let s2=s.substring(pos2,pos3)+" ",width=0,height=0,posw=s2.indexOf("width=");if(posw>=0){let posw2=s2.indexOf(" ",posw);if(posw2>=0){let num=s2.slice(posw+6,posw2).replace(/"/g,"");width=parseInt(num),s2=s2.slice(0,posw)+s2.slice(posw2)}}if(posw=s2.indexOf("height="),posw>=0){let posw2=s2.indexOf(" ",posw);if(posw2>=0){let num=s2.slice(posw+7,posw2).replace(/"/g,"");height=parseInt(num),s2=s2.slice(0,posw)+s2.slice(posw2)}}if(width>0&&height>0){let newWidth=width-subwidth>0?width-subwidth:width/2,newHeight=height-subheight>0?height-subheight:height/2,ratio=Math.max(minRatio,Math.min(newWidth/width,newHeight/height));s2=s2+' width="'+Math.round(ratio*width)+'" height="'+Math.round(height*ratio)+'" '}s=s.slice(0,pos2)+s2+s.slice(pos3),pos=pos3}item.innerHTML=s}pad(num,size){let s=num+"";for(;s.length<size;)s="0"+s;return s}uuid4(){const uuid=[...Array(36)].map((()=>"0123456789abcdef"[Math.floor(16*Math.random())]));uuid[8]=uuid[13]=uuid[18]=uuid[23]="-",uuid[14]="4",uuid[19]="0123456789abcdef"[3&parseInt(uuid[19],16)|8],this.user=uuid.join("");let options={userGUID:this.user},instance=this;this.setOptions(options).then((function(){return!0})).catch((error=>(instance.showError(error.message),!1)))}getCopyrightHeight(){return Math.round(this.iconSize/3)}getColorHex(colorCode){return"#".concat(colorCode.toString(16).padStart(6,"0").toUpperCase())}getContrast(colorCode){return(299*(colorCode>>16&255)+587*(colorCode>>8&255)+114*(255&colorCode))/1e3}getColorGray(x){let yiq=299*(Math.floor(x/16777216)%256)+587*(Math.floor(x/65536)%256)+114*(Math.floor(x/256)%256),gray=Math.round(255*yiq/255e3);return 65536*gray+256*gray+gray}getContrastingColor(colorCode){return(299*(colorCode>>16&255)+587*(colorCode>>8&255)+114*(255&colorCode))/1e3>=128?"#000000":"#FFFFFF"}repairColors(colors){this.colors=colors.sort(((a,b)=>this.getContrast(a)-this.getContrast(b))),this.colorBackground=this.colors[0],this.body.style.backgroundColor=this.getColorHex(this.colorBackground)}repairP(text){return text?text.replace(/<p[^>]*>/g,"").replace(/<\/p>/g,"<br>").trim():""}createButtonHelp(left,top){this.createImage(this.body,"mmogame-button-helo",left,top,this.iconSize,this.iconSize,"assets/help.png").alt="Help"}findbest(low,high,condition){for(;high-low>1;){const mid=Math.floor((low+high)/2);condition(mid)?high=mid:low=mid}return low}removeDivMessage(){void 0!==this.divMessage&&(this.body.removeChild(this.divMessage),this.divMessage=void 0),void 0!==this.divMessageHelp&&(this.body.removeChild(this.divMessageHelp),this.divMessageHelp=void 0),void 0!==this.divMessageBackground&&(this.divMessageBackground.remove(),this.divMessageBackground=void 0)}disableButtons(buttons,disabled){for(let i=0;i<buttons.length;i++){let btn=buttons[i];void 0!==btn&&(disabled?btn.classList.add("mmogame_imgbutton_disabled"):btn.classList.remove("mmogame_imgbutton_disabled"))}}repairNickname(nickname){if(void 0===nickname)return"";let s=nickname;if(""!==s)for(;-1!==s.indexOf("_");)s=s.replace("_"," ");return s}showColorPalette(canvas,colors){let ctx=canvas.getContext("2d"),width=canvas.width,height=canvas.height,strip=width/5,instance=this;colors.sort((function(a,b){return instance.getContrast(a)-instance.getContrast(b)}));for(let i=0;i<5;i++)ctx.fillStyle=this.getColorHex(colors[i]),ctx.fillRect(i*strip,0,(i+1)*strip,height);ctx.strokeStyle="#FFFFFF",ctx.lineWidth=1,ctx.strokeRect(0,0,width,height)}setColorsString(s){let a=[10190553,7992050,6799194,13693522,12540705];if(void 0!==s&&s.length>=0){let b=s.split(",");if(5===b.length){a=b;for(let i=0;i<5;i++)a[i]=parseInt(a[i])}}this.setColors(a)}computeDifClock(time,timeStart,timeClose){void 0!==time&&(this.difClock=((new Date).getTime()-time)/1e3),this.computeTimeStartClose(timeStart,timeClose)}computeTimeStartClose(timeStart,timeClose){void 0!==timeStart?(this.timestart=0!==parseInt(timeStart)?parseInt(timeStart)+this.difClock:0,this.timeclose=0!==parseInt(timeClose)?parseInt(timeClose)+this.difClock:0):(this.timestart=0,this.timeclose=0)}drawRadio(canvas,color1,color2){let ctx=canvas.getContext("2d"),size=canvas.width;ctx.clearRect(0,0,size,canvas.height),ctx.beginPath(),ctx.arc(size/2,size/2,size/2,0,2*Math.PI,!1),ctx.fillStyle=this.getColorHex(color1),ctx.fill(),canvas.classList.contains("checked")&&(ctx.beginPath(),ctx.arc(size/2,size/2,size/4,0,2*Math.PI,!1),ctx.fillStyle=this.getColorHex(color2),ctx.fill())}createRadiobox(parent,size,color1,color2,checked,disabled){let canvas=document.createElement("canvas");return canvas.style.position="absolute",canvas.width=size,canvas.height=size,parent.appendChild(canvas),checked&&canvas.classList.add("checked"),disabled&&canvas.classList.add("disabled"),this.drawRadio(canvas,disabled?color1:16777215,color2),canvas}createImageButton(parent,classnames,left,top,width,height,filename){const imgButton=this.createImage(parent,classnames,left,top,width,height,filename);return imgButton.style.cursor="pointer",imgButton}createDivColor(parent,classnames,left,top,width,height,color){const colorDiv=this.createDiv(parent,classnames,left,top,width,height);return colorDiv.style.backgroundColor=color,colorDiv.style.border="1px solid #000",colorDiv}getStringM(name){return M.util.get_string(name,"mmogame")}getOptions(){return new Promise(((resolve,reject)=>{const request=indexedDB.open("mmoGameDB",1);request.onupgradeneeded=function(event){const db=event.target.result;db.objectStoreNames.contains("options")||db.createObjectStore("options",{keyPath:"name"})},request.onsuccess=function(event){const getAllRequest=event.target.result.transaction(["options"],"readonly").objectStore("options").getAll();getAllRequest.onsuccess=function(event){resolve(event.target.result.reduce(((acc,item)=>(acc[item.name]=item.value,acc)),{}))},getAllRequest.onerror=function(){reject(new Error("Failed to retrieve options"))}},request.onerror=function(){reject(new Error("Failed to open database"))}}))}setOptions(options){return new Promise(((resolve,reject)=>{const request=indexedDB.open("mmoGameDB",1);request.onsuccess=function(event){const transaction=event.target.result.transaction(["options"],"readwrite"),store=transaction.objectStore("options");Object.entries(options).forEach((_ref2=>{let[key,value]=_ref2;store.put({name:key,value:value})})),transaction.oncomplete=function(){resolve()},transaction.onerror=function(){reject(new Error("Failed to save options"))}},request.onerror=function(){reject(new Error("Failed to open database"))}}))}clearDB(url){this.setOptions({nickname:""}).then((function(){return window.location.href=url,!0})).catch((()=>!1))}debounce(func,delay){let timer;return function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];clearTimeout(timer),timer=setTimeout((()=>func.apply(this,args)),delay)}}}}));

//# sourceMappingURL=mmogame.min.js.map