function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}define("mmogametype_quiz/mmogametypequiz",["mod_mmogame/mmogameui"],(function(MmoGameUI){return class extends MmoGameUI{
/**
     * Base class for Quiz mmmogame
     *
     * @module mmogametype_quiz
     * @copyright 2024 Vasilis Daloukas
     * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
     */
constructor(){super(),_defineProperty(this,"mmogameid",void 0),_defineProperty(this,"kinduser",void 0),_defineProperty(this,"user",void 0),_defineProperty(this,"url",void 0),_defineProperty(this,"pin",void 0),_defineProperty(this,"labelTimer",void 0),_defineProperty(this,"timeForSendAnswer",void 0),_defineProperty(this,"divDefinition",void 0),_defineProperty(this,"definitionHeight",void 0),this.hideSubmit=!1,this.timeForSendAnswer=1e4}openGame(){super.openGame(),this.audioYes=new Audio("assets/yes1.mp3"),this.audioYes.load(),this.audioNo=new Audio("assets/no1.mp3"),this.audioNo.load()}processGetAttempt(json){var _json$answer;this.computeDifClock(json.time,json.timestart,json.timeclose),json.colors&&(this.setColorsString(json.colors),this.createIconBar()),json.name&&(document.title=json.name),json.helpurl&&(this.helpUrl=json.helpurl),json.errorcode?this.createDivMessage("mmogame-error",json.errorcode):(this.state=parseInt(json.state,10),this.fastjson=json.fastjson,this.timefastjson=parseInt(json.timefastjson,10),this.updateButtonsAvatar(1,json.avatar,json.nickname),this.attempt=json.attempt,this.qtype=json.qtype,"multichoice"===this.qtype&&(this.answers=[],this.answersID=json.answerids,json.answers.forEach(((answer,index)=>{this.answers[index]=this.repairP(answer)}))),this.answer=null!==(_json$answer=json.answer)&&void 0!==_json$answer?_json$answer:void 0,this.endofgame=void 0!==json.endofgame&&0!==json.endofgame,this.definition=this.repairP(json.definition),this.errorcode=json.errorcode,0!==json.state&&this.createScreen(json,!1),this.updateLabelTimer(),this.sendFastJSON())}updateLabelTimer(){if(!this.labelTimer||!this.timeclose)return;const now=Date.now()/1e3;let remainingTime=Math.max(0,this.timeclose-now);if(0===remainingTime)return this.labelTimer.innerHTML="",void this.onTimeout();const minutes=Math.floor(remainingTime/60),seconds=String(Math.floor(remainingTime%60)).padStart(2,"0");this.labelTimer.innerHTML="".concat(minutes,":").concat(seconds),this.timerTimeout=setTimeout((()=>this.updateLabelTimer()),500)}onTimeout(){this.labelTimer.innerHTML="",this.disableInput(),this.sendTimeout()}createScreen(json,disabled){if(this.createArea(),this.endofgame)return this.createDivMessage("mmogame-endofgame",this.getStringM("js_game_over")),void this.showScore(json);this.vertical?this.createScreenVertical(disabled):this.createScreenHorizontal(disabled),this.showScore(json)}createScreenVertical(disabled){const nickNameHeight=Math.round(this.iconSize/3)+this.padding;let maxHeight=this.areaHeight-4*this.padding-nickNameHeight;this.hideSubmit||(maxHeight-=this.iconSize);const maxWidth=this.areaWidth;this.fontSize=this.findbest(this.minFontSize,this.maxFontSize,(fontSize=>{const defSize=this.createDefinition(0,0,maxWidth-1,!0,fontSize);if(defSize[0]>=maxWidth)return 1;const ansSize=this.createAnswer(0,0,maxWidth-1,!0,fontSize,disabled);return defSize[1]+ansSize[1]<maxHeight?-1:1})),this.radioSize=Math.round(this.fontSize);const defSize=this.createDefinition(0,0,maxWidth,!1,this.fontSize);if(this.nextTop=this.createAnswer(0,defSize[1]+this.padding,maxWidth,!1,this.fontSize,disabled),!this.hideSubmit){const space=(this.areaWidth-this.iconSize)/2;this.btnSubmit=this.createImageButton(this.area,"mmogame-quiz-submit",space,this.nextTop,0,this.iconSize,"assets/submit.svg",!1,"submit"),this.btnSubmit.addEventListener("click",(()=>{this.area.removeChild(this.btnSubmit),this.btnSubmit=void 0,this.sendAnswer()}))}this.stripLeft=this.padding,this.stripWidth=2*this.iconSize,this.stripHeight=this.iconSize}createScreenHorizontal(disabled){let maxHeight=this.areaHeight-2*this.padding;this.hideSubmit||(maxHeight-=this.iconSize+this.padding);const width=Math.round((this.areaWidth-this.padding)/2);for(let step=1;step<=2;step++){let defSize;if(this.fontSize=this.findbest(1===step?this.minFontSize:this.minFontSize/2,this.maxFontSize,(fontSize=>{if(defSize=this.createDefinition(0,0,width-this.padding,!0,fontSize),defSize[0]>=width)return 1;let ansSize=this.createAnswer(0,0,width-this.padding,!0,fontSize,disabled);return ansSize[0]>=width?1:defSize[1]<maxHeight&&ansSize[1]<maxHeight?-1:1})),defSize[0]<=width&&defSize[1]<=this.areaHeight)break}this.radioSize=Math.round(this.fontSize),this.createDefinition(0,0,width-this.padding,!1,this.fontSize),this.nextTop=this.createAnswer(width,0,width-this.padding,!1,this.fontSize,disabled)+this.padding,this.hideSubmit||(this.btnSubmit=this.createImageButton(this.body,"mmogame-quiz-submit",width+(width-this.iconSize)/2,this.nextTop,0,this.iconSize,"assets/submit.svg",!1,"submit"),this.btnSubmit.addEventListener("click",(()=>{this.sendAnswer()}))),this.stripLeft=width+this.padding,this.stripWidth=2*this.iconSize,this.stripHeight=this.iconSize}createAnswer(left,top,width,onlyMetrics,fontSize,disabled){return this.createAnswerMultichoice(left,top,width,onlyMetrics,fontSize,disabled)}createAnswerMultichoice(left,top,width,onlyMetrics,fontSize,disabled){var _this$answer;const n=this.answers?this.answers.length:0,aChecked=(null===(_this$answer=this.answer)||void 0===_this$answer?void 0:_this$answer.split(",").filter(Boolean))||[],retSize=[0,0],checkboxSize=Math.round(fontSize);this.aItemAnswer=Array(n),this.aItemLabel=Array(n),this.aItemCorrectX=new Array(n);for(let i=0;i<n;i++){const label=document.createElement("label");if(label.style.position="absolute",label.style.width="".concat(width,"px"),label.style.fontSize="".concat(fontSize,"px"),label.style.color=this.getContrastingColor(this.colorBackground),label.innerHTML=this.answers[i],label.classList.add("mmogame-quiz-multichoice-label"),onlyMetrics){this.area.appendChild(label);const newSize=label.scrollWidth+fontSize+this.padding;retSize[0]=Math.max(retSize[0],newSize),retSize[1]+=Math.max(label.scrollHeight,fontSize)+this.padding,this.area.removeChild(label);continue}label.htmlFor="mmogame_quiz_input"+i,label.style.left=left+fontSize+this.padding+"px",label.style.top=top+"px",label.style.align="left",label.style.color=this.getContrastingColor(this.colorBackground);const checked=aChecked.includes(this.answersID[i]),item=this.createRadiobox(this.body,checkboxSize,this.colorBackground2,this.colorScore,checked,disabled);item.style.position="absolute",item.style.left="".concat(left,"px"),item.style.top="".concat(top,"px"),item.id="mmogame_quiz_input"+i,item.addEventListener("click",(()=>{item.classList.contains("disabled")||this.onClickRadio(i,this.colorBackground2,this.colorScore,!0)})),label.addEventListener("click",(()=>{this.onClickRadio(i,this.colorBackground2,this.colorScore,!0)})),this.area.appendChild(item),this.area.appendChild(label),this.aItemAnswer[i]=item,this.aItemCorrectX[i]=left+fontSize+this.padding,this.aItemLabel[i]=label,top+=Math.max(label.scrollHeight,fontSize)+this.padding}return onlyMetrics?retSize:top}onClickRadio(index,colorBack,color,callSendAnswer){this.aItemAnswer[index].classList.contains("disabled")||(this.aItemAnswer.forEach(((item,i)=>{const isDisabled=item.classList.contains("disabled");i===index?(item.classList.add("checked"),this.answerid=this.answersID[i]):item.classList.remove("checked"),this.drawRadio(item,isDisabled?colorBack:16777215,color)})),this.autosave&&callSendAnswer&&this.callSetAnswer())}sendTimeout(){let xmlhttp=new XMLHttpRequest;xmlhttp.onreadystatechange=()=>{4===this.readyState&&200===this.status&&this.sendGetAttempt()},xmlhttp.open("POST",this.url,!0),xmlhttp.setRequestHeader("Content-Type","application/json");let data=JSON.stringify({command:"timeout",mmogameid:this.mmogameid,pin:this.pin,kinduser:this.kinduser,user:this.user,attempt:this.attempt});xmlhttp.send(data)}getSVGcorrect(size,iscorrect,colorCorrect,colorError){if(iscorrect){return'<svg aria-hidden="true" class="svg-icon iconCheckmarkLg" width="'+size+'" height="'+size+'" viewBox="0 0 36 36"><path fill="'+(void 0!==colorCorrect?this.getColorHex(colorCorrect):"#398439")+'" d="m6 14 8 8L30 6v8L14 30l-8-8v-8z"></path></svg>'}return'<svg width="'+size+'" height="'+size+'" class="bi bi-x-lg" viewBox="0 0 18 18"> <path fill="'+(void 0!==colorError?this.getColorHex(colorError):"#398439")+'" d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 \n                1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/></svg>'}updateScreenAfterAnswerMultichoice(){const correctAnswers=this.correct.split(",");for(let i=0;i<this.answersID.length;i++){const label=this.aItemLabel[i],isChecked=this.aItemAnswer[i].classList.contains("checked"),isCorrect=correctAnswers.includes(this.answersID[i]);if(!isCorrect&&!isChecked)continue;const labelWidth=label.scrollWidth-this.radioSize;label.style.left="".concat(parseInt(label.style.left)+this.radioSize,"px"),label.style.width="".concat(labelWidth,"px"),isCorrect&&(label.innerHTML="<b>".concat(label.innerHTML,"</b>"));const top=parseInt(this.aItemAnswer[i].style.top);this.createDiv(this.area,"mmogame-quiz-correct",this.aItemCorrectX[i],top,this.radioSize,this.radioSize).innerHTML=this.getSVGcorrect(this.radioSize,isCorrect,this.colorScore,this.colorScore)}}disableInput(){if(this.aItemAnswer)for(const item of this.aItemAnswer)item.classList.add("disabled"),this.drawRadio(item,this.colorScore,this.colorBackground2)}sendFastJSON(){void 0!==this.timeoutFastJSON&&clearTimeout(this.timeoutFastJSON),this.timeoutFastJSON=setTimeout((()=>{const xhr=new XMLHttpRequest;xhr.onreadystatechange=()=>{this.timeoutFastJSON=void 0,4===xhr.readyState&&200===xhr.status&&this.onServerFastJson(xhr.response)};const url="".concat(this.url,"/state.php");xhr.open("POST",url,!0);const data=new FormData;data.set("fastjson",this.fastjson),data.set("type",this.type),xhr.send(data)}),this.timeForSendAnswer)}onClickHelp(){""!==this.helpUrl&&window.open(this.helpUrl,"_blank")}getStringT(name){return M.util.get_string(name,"mmogametype_quiz")}createDivScorePercent(prefixclassname,left,top,color,createAddScore){const main=this.createDOMElement("div",{parent:this.body,classnames:"".concat(prefixclassname,"-main"),styles:{position:"absolute",left:"".concat(left,"px"),top:"".concat(top,"px"),width:"".concat(this.iconSize,"px"),height:"".concat(this.iconSize,"px"),border:"0px solid "+this.getColorHex(16777215),boxShadow:"inset 0 0 0.125em rgba(255, 255, 255, 0.75)",color:color},attributes:{disabled:!0,innerHTML:""}}),scoreLabel=this.createDOMElement("div",{parent:this.body,classnames:"".concat(prefixclassname,"-score"),styles:{position:"absolute",left:"".concat(left,"px"),top:"".concat(top+this.iconSize/4,"px"),width:"".concat(this.iconSize/2,"px"),height:"".concat(this.iconSize/2,"px"),lineHeight:"".concat(this.iconSize/2,"px"),textAlign:"center",color:this.getContrastingColor(this.colorScore)},attributes:{title:this.getStringM("js_grade")}}),rankLabel=this.createDOMElement("div",{parent:this.body,classnames:"".concat(prefixclassname,"-rank"),styles:{position:"absolute",left:"".concat(left,"px"),top:"".concat(top,"px"),width:"".concat(this.iconSize/2,"px"),height:"".concat(this.iconSize/3,"px"),textAlign:"center",color:this.getContrastingColor(this.colorScore)},attributes:{title:this.getStringM("js_ranking_grade")}}),percentLabel=this.createDOMElement("div",{parent:this.body,classnames:"".concat(prefixclassname,"-percent"),styles:{position:"absolute",left:"".concat(left+this.iconSize/2,"px"),top:"".concat(top,"px"),width:"".concat(this.iconSize/2,"px"),height:"".concat(this.iconSize/3,"px"),textAlign:"center",fontSize:"".concat(this.iconSize/3,"px"),lineHeight:"".concat(this.iconSize/3,"px"),color:rankLabel.style.color},attributes:{title:this.getStringM("js_ranking_percent")}});let addScoreLabel=null;return createAddScore&&(addScoreLabel=this.createDOMElement("div",{parent:this.body,classnames:"".concat(prefixclassname,"-addscore"),styles:{position:"absolute",left:"".concat(left+this.iconSize/2,"px"),top:"".concat(top+this.iconSize-this.iconSize/3,"px"),width:"".concat(this.iconSize/2,"px"),height:"".concat(this.iconSize/3,"px"),textAlign:"center",fontWeight:"bold",color:color},attributes:{title:this.getStringM("js_percent")}})),{main:main,scoreLabel:scoreLabel,rankLabel:rankLabel,percentLabel:percentLabel,addScoreLabel:addScoreLabel}}createDefinition(left,top,width,onlyMetrics,fontSize){width-=2*this.padding;const definitionDiv=document.createElement("div");if(definitionDiv.style.position="absolute",definitionDiv.style.width="".concat(width,"px"),definitionDiv.style.fontSize="".concat(fontSize,"px"),definitionDiv.innerHTML=this.definition,onlyMetrics){this.body.appendChild(definitionDiv);const size=[definitionDiv.scrollWidth,definitionDiv.scrollHeight];return this.body.removeChild(definitionDiv),size}definitionDiv.style.background=this.getColorHex(this.colorBackground2),definitionDiv.style.color=this.getContrastingColor(this.colorBackground2),definitionDiv.style.left="".concat(left,"px"),definitionDiv.style.top="".concat(top,"px"),definitionDiv.style.paddingLeft="".concat(this.padding,"px"),definitionDiv.style.paddingRight="".concat(this.padding,"px"),this.area.appendChild(definitionDiv);const height=definitionDiv.scrollHeight+this.padding;return definitionDiv.style.height="".concat(height,"px"),this.definitionHeight=height,this.divDefinition=definitionDiv,[definitionDiv.scrollWidth,definitionDiv.scrollHeight]}showScore(_ref){let{addscore:addscore,completedrank:completedrank,percentcompleted:percentcompleted,rank:rank,sumscore:sumscore,usercode:usercode}=_ref;const scoreText=void 0!==sumscore?"<b>".concat(sumscore,"</b>"):"";this.labelScore.innerHTML!==scoreText&&(this.labelScore.innerHTML=scoreText,this.autoResizeText(this.labelScore,this.iconSize-2*this.padding,this.iconSize/2,!1,0,0,1)),this.labelScoreRank.innerHTML!==rank&&(this.labelScoreRank.innerHTML=rank||"",this.autoResizeText(this.labelScoreRank,this.iconSize,this.iconSize/3,!0,0,0,1)),void 0!==usercode&&(document.title="".concat(usercode," ").concat(name||""));const addScoreText=void 0!==addscore?addscore:"";this.labelAddScore.innerHTML!==addScoreText&&(this.labelAddScore.innerHTML=addScoreText,this.autoResizeText(this.labelAddScore,this.iconSize-2*this.padding,this.iconSize/3,!1,0,0,1)),this.labelScoreRankB.innerHTML!==completedrank&&(this.labelScoreRankB.innerHTML=completedrank||"",this.autoResizeText(this.labelScoreRankB,.9*this.iconSize/2,this.iconSize/3,!0,0,0,1));const percentageText=void 0!==percentcompleted?"".concat(Math.round(100*percentcompleted),"%"):"";this.labelScoreB.innerHTML!==percentageText&&(this.labelScoreB.innerHTML=percentageText,this.autoResizeText(this.labelScoreB,.8*this.iconSize/2,this.iconSize/3,!0,0,0,1))}callSetAnswer(){void 0!==this.timerTimeout&&clearTimeout(this.timerTimeout),this.timerTimeout=void 0,require(["core/ajax"],(Ajax=>{const params={mmogameid:this.mmogameid,kinduser:this.kinduser,user:this.user,attempt:this.attempt,answer:this.answer||null,answerid:this.answerid||null,subcommand:""};Ajax.call([{methodname:"mmogametype_quiz_set_answer",args:params}])[0].done((response=>{this.processSetAnswer(JSON.parse(response))})).fail((error=>{this.showError(error)}))}))}setColors(colors){super.setColors(colors),this.colorScore=colors[2],this.colorCopyright=colors[3],this.colorScore2=colors[4]}}}));

//# sourceMappingURL=mmogametypequiz.min.js.map