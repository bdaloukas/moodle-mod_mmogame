function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}define("mmogametype_quiz/mmogamequiz",["mod_mmogame/mmogame"],(function(mmoGame){return class extends mmoGame{
/**
     * Base class for Quiz mmmogame
     *
     * @module mmogametype_quiz
     * @copyright 2024 Vasilis Daloukas
     * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
     */
constructor(){super(),_defineProperty(this,"mmogameid",void 0),_defineProperty(this,"kinduser",void 0),_defineProperty(this,"auserid",void 0),_defineProperty(this,"url",void 0),_defineProperty(this,"pin",void 0),_defineProperty(this,"labelTimer",void 0),this.hideSubmit=!1}setColors(colors,nameLoad){let c=this.repairColors(colors,nameLoad);this.colorDefinition=c[1],this.colorScore=c[2],this.colorScore2=c[4]}openGame(url,id,pin,auserid,kinduser,callOnAfterOpenGame){super.openGame(url,id,pin,auserid,kinduser,callOnAfterOpenGame),this.audioYes=new Audio("assets/yes1.mp3"),this.audioYes.load(),this.audioNo=new Audio("assets/no1.mp3"),this.audioNo.load()}sendGetAttempt(param,subcommand){let xmlhttp=new XMLHttpRequest,instance=this;xmlhttp.onreadystatechange=function(){4===this.readyState&&200===this.status&&instance.onServerGetAttempt(JSON.parse(this.responseText),param)},xmlhttp.open("POST",this.url,!0),xmlhttp.setRequestHeader("Content-Type","application/json");let d={command:"getattempt",mmogameid:this.mmogameid,pin:this.pin,kinduser:this.kinduser,user:this.auserid,subcommand:subcommand};void 0===this.helpurl&&(d.helpurl=1);let data=JSON.stringify(d);xmlhttp.send(data)}onServerGetAttempt(json){if(this.computeDifClock(json),void 0===this.colors&&(this.setColorsString(json.colors),this.createIconBar()),void 0!==json.name&&(window.document.title=json.name),void 0!==json.helpurl&&(this.helpUrl=json.helpurl),void 0===json.errorcode){if(this.state=parseInt(json.state),this.fastjson=json.fastjson,this.timefastjson=parseInt(json.timefastjson),this.updateButtonsAvatar(1,json.avatar,json.nickname),this.attempt=json.attempt,this.qtype=json.qtype,"multichoice"===json.qtype){this.answers=[],this.answersID=[];for(let i=1;i<=json.answers;i++){let answerid=json["answerid_"+i],answer=this.repairP(json["answer_"+i]);this.answersID.push(answerid),this.answers.push(answer)}}this.answer=void 0!==json.answer?json.answer:null,this.endofgame=void 0!==json.endofgame&&0!==json.endofgame,this.definition=this.repairP(json.definition),this.single=json.single,this.errorcode=json.errorcode,this.readJsonFiles(json),0!==json.state&&this.createScreen(json,!1),this.updateLabelTimer(),this.sendFastJSON()}else this.createDivMessage(json.errorcode)}updateLabelTimer(){if(void 0===this.labelTimer||void 0===this.timeclose)return;if(0===this.timeclose)return void(this.labelTimer.innerHTML="");let time=(new Date).getTime(),dif=this.timeclose-time/1e3;if(dif<=0&&(dif=0),dif=Math.round(dif),dif<=0)this.labelTimer.innerHTML="",this.onTimeout();else{let s=(dif<0?"-":"")+Math.floor(dif/60);this.labelTimer.innerHTML=s+":"+("0"+dif%60).slice(-2)}if(dif<=0&&0!==this.timeclose)return;let instance=this;this.timerTimeout=setTimeout((function(){instance.updateLabelTimer()}),500)}onTimeout(){this.labelTimer.innerHTML="",this.disableInput(),this.sendTimeout()}createScreen(json,disabled){if(void 0!==this.area&&(this.body.removeChild(this.area),this.area=void 0),this.removeDivMessage(),this.area=this.createDiv(this.body,this.padding,this.areaTop,this.areaWidth,this.areaHeight),this.endofgame)return this.createDivMessage("LANGM_GAME_OVER_"+this.errorcode),void this.showScore(json);this.vertical?this.createScreenVertical(disabled):this.createScreenHorizontal(disabled),this.showScore(json)}createScreenVertical(disabled){let nickNameHeight=Math.round(this.iconSize/3)+this.padding,maxHeight=this.areaHeight-4*this.padding-nickNameHeight;!1===this.hideSubmit&&(maxHeight-=this.iconSize);let instance=this,maxWidth=this.areaWidth;this.fontSize=this.findbest(this.minFontSize,this.maxFontSize,(function(fontSize){let defSize=instance.createDefinition(0,0,maxWidth-1,!0,fontSize);if(defSize[0]>=maxWidth)return 1;let ansSize=instance.createAnswer(0,0,maxWidth-1,!0,fontSize,disabled);return ansSize[0]>=maxWidth?1:defSize[1]+ansSize[1]<maxHeight?-1:1})),this.radioSize=Math.round(this.fontSize),this.explainLeft=0;let defSize=this.createDefinition(0,0,maxWidth,!1,this.fontSize);if(this.nextTop=instance.createAnswer(0,defSize[1]+this.padding,maxWidth,!1,this.fontSize,disabled),this.nextLeft=this.areaWidth-this.iconSize-this.padding,this.nextTop+this.padding>=this.areaHeight&&(this.nextTop=this.areaHeight-this.padding),!1===this.hideSubmit){let top=(this.areaWidth-this.iconSize)/2;this.btnSubmit=this.createImageButton(this.body,top,this.nextTop,0,this.iconSize,"","assets/submit.svg",!1,"submit"),this.btnSubmit.addEventListener("click",(function(){void 0!==instance.btnSubmit&&(instance.area.removeChild(instance.btnSubmit),instance.btnSubmit=void 0),instance.sendAnswer(!0)}))}this.stripLeft=this.padding,this.stripTop=this.nextTop,this.stripWidth=2*this.iconSize,this.stripHeight=this.iconSize}createScreenHorizontal(disabled){let maxHeight=this.areaHeight-2*this.padding;!1===this.hideSubmit&&(maxHeight-=this.iconSize+this.padding);let width=Math.round((this.areaWidth-this.padding)/2),instance=this;for(let step=1;step<=2;step++){let defSize;if(this.fontSize=this.findbest(1===step?this.minFontSize:this.minFontSize/2,this.maxFontSize,(function(fontSize){if(defSize=instance.createDefinition(0,0,width-instance.padding,!0,fontSize),defSize[0]>=width)return 1;let ansSize=instance.createAnswer(0,0,width-instance.padding,!0,fontSize,disabled);return ansSize[0]>=width?1:defSize[1]<maxHeight&&ansSize[1]<maxHeight?-1:1})),defSize[0]<=width&&defSize[1]<=instance.areaHeight)break}this.radioSize=Math.round(this.fontSize),this.createDefinition(0,0,width-this.padding,!1,this.fontSize),this.nextTop=instance.createAnswer(width,0,width-this.padding,!1,this.fontSize,disabled)+this.padding,this.nextLeft=width+Math.min(3*this.iconSize+2*this.padding,width-this.iconSize),this.hideSubmit||(this.btnSubmit=this.createImageButton(this.body,width+(width-this.iconSize)/2,this.nextTop,0,this.iconSize,"","assets/submit.svg",!1,"submit"),this.btnSubmit.addEventListener("click",(function(){instance.sendAnswer(!0)})),this.stripLeft=width+this.padding,this.stripTop=this.nextTop,this.stripWidth=2*this.iconSize,this.stripHeight=this.iconSize)}createAnswer(left,top,width,onlyMetrics,fontSize,disabled){return this.createAnswerMultichoice(left,top,width,onlyMetrics,fontSize,disabled)}createAnswerMultichoice(left,top,width,onlyMetrics,fontSize,disabled){let n=this.answers.length,instance=this,aChecked=[];null!==this.answer&&(aChecked=this.answer.split(",")),aChecked.length>0&&""===aChecked[0]&&aChecked.pop(),this.multichoiceLeft=left,this.aItemAnswer=new Array(n),this.aItemLabel=new Array(n),this.aItemCorrectX=new Array(n);let retSize=[0,0];this.labelWidth=Math.round(width-fontSize-this.padding-this.getMultichoiceSpace(fontSize));let checkboxSize=Math.round(fontSize),top1=top,offsetLabel=this.getMultichoiceSpace(fontSize);for(let i=0;i<n;i++){let label=document.createElement("label");if(label.style.position="absolute",label.style.width=this.labelWidth+"px",label.innerHTML=this.repairHTML(this.answers[i],this.mapFiles,this.mapFilesWidth,this.mapFilesHeight),label.style.font="FontAwesome",label.style.fontSize=fontSize+"px",this.aItemLabel[i]=label,onlyMetrics){this.body.appendChild(label);let newSize=label.scrollWidth+fontSize+this.padding+this.getMultichoiceSpace(fontSize);newSize>retSize[0]&&(retSize[0]=newSize),retSize[1]+=Math.max(label.scrollHeight,fontSize)+this.padding,this.body.removeChild(label);continue}label.htmlFor="input"+i,label.style.left=left+fontSize+this.padding+offsetLabel+"px",label.style.top=top+"px",label.style.align="left",label.style.color=this.getColorContrast(this.colorBackground);let checked=aChecked.includes(this.answersID[i]),item=this.createRadiobox(this.body,checkboxSize,this.colorDefinition,this.colorScore,checked,disabled);item.style.position="absolute",item.style.left=left+"px";let topRadio=top;item.style.top=topRadio+"px",item.addEventListener("click",(()=>{item.classList.contains("disabled")||instance.onClickRadio(i,this.colorDefinition,this.colorScore,!0)})),label.addEventListener("click",(()=>{instance.onClickRadio(i,instance.colorDefinition,instance.colorScore,!0)})),this.area.appendChild(item),this.area.appendChild(label),label.scrollHeight>fontSize&&(topRadio=Math.round(top+(label.scrollHeight-fontSize)/2),item.style.top=topRadio+"px"),""===this.answersID[i]&&(item.style.visibility="hidden",label.style.visibility="hidden"),this.aItemAnswer[i]=item,this.aItemCorrectX[i]=left+fontSize+this.padding,top+=Math.max(label.scrollHeight,fontSize)+this.padding}if(onlyMetrics)return retSize;let vspace,heightControls=top-top1;if(!1===this.vertical&&(vspace=this.areaHeight-heightControls-this.iconSize,vspace>this.padding)){let move=Math.round(vspace/3);for(let i=0;i<n;i++)this.aItemAnswer[i].style.top=parseInt(this.aItemAnswer[i].style.top)+move+"px",this.aItemLabel[i].style.top=parseInt(this.aItemLabel[i].style.top)+move+"px";this.nextTop+=move/2,parseInt(this.divDefinition.style.top)+move+this.definitionHeight+this.padding<this.areaHeight&&(this.divDefinition.style.top=this.aItemLabel[0].style.top,this.divDefinition.style.height=Math.max(heightControls,this.definitionHeight)+"px"),top+=move}return top}onClickRadio(i,colorBack,color,callSendAnswer){if(!this.aItemAnswer[i].classList.contains("disabled")){for(let j=0;j<this.aItemAnswer.length;j++){let item=this.aItemAnswer[j],disabled=item.classList.contains("disabled");i===j?(item.classList.add("checked"),this.answer=this.answersID[i]):item.classList.contains("checked")&&item.classList.remove("checked"),this.drawRadio(item,disabled?colorBack:16777215,color)}this.autosave&&callSendAnswer&&this.sendAnswer(this.autosubmit)}}getMultichoiceSpace(){return 0}sendAnswer(submit,subcommand){submit&&(clearTimeout(this.timerTimeout),this.timerTimeout=void 0);let xmlhttp=new XMLHttpRequest,instance=this;xmlhttp.onreadystatechange=function(){if(4===this.readyState&&200===this.status){let json=JSON.parse(this.responseText);submit&&(json.submit=1),instance.onServerAnswer(json)}},xmlhttp.open("POST",this.url,!0),xmlhttp.setRequestHeader("Content-Type","application/json");let a={command:"answer",mmogameid:this.mmogameid,pin:this.pin,kinduser:this.kinduser,user:this.auserid,attempt:this.attempt,answer:this.answer,submit:submit?1:0};void 0!==subcommand&&(a.subcommand=subcommand);let data=JSON.stringify(a);xmlhttp.send(data)}sendTimeout(){let xmlhttp=new XMLHttpRequest,instance=this;xmlhttp.onreadystatechange=function(){4===this.readyState&&200===this.status&&instance.sendGetAttempt()},xmlhttp.open("POST",this.url,!0),xmlhttp.setRequestHeader("Content-Type","application/json");let data=JSON.stringify({command:"timeout",mmogameid:this.mmogameid,pin:this.pin,kinduser:this.kinduser,user:this.auserid,attempt:this.attempt});xmlhttp.send(data)}onServerAnswer(json){if(0===json.submit)return;this.correct=json.correct,this.playAudio(0!==json.iscorrect?this.audioYes:this.audioNo),void 0!==json.correct&&"multichoice"===this.qtype&&this.onServerAnswerMultichoice(json),this.disableInput(),void 0!==this.btnSubmit&&(this.body.removeChild(this.btnSubmit),this.btnSubmit=void 0);let btn=super.createImageButton(this.area,this.nextLeft,this.nextTop,0,this.iconSize,"","assets/next.svg",!1,"alt"),instance=this;if(btn.addEventListener("click",(function(){instance.sendGetAttempt(),instance.area.removeChild(btn)})),!json.iscorrect&&"multichoice"!==this.qtype){let w=this.nextLeft-this.explainLeft-2*this.padding-this.iconSize,ans2=this.createDiv(this.body,this.explainLeft+this.iconSize+this.padding,this.nextTop,this.iconSize,this.iconSize);ans2.style.lineHeight=this.iconSize+"px",ans2.style.color=this.getColorContrast(this.colorBackground),ans2.innerHTML=json.correct,this.autoResizeText(ans2,w,this.iconSize,!1,this.minFontSize,this.maxFontSize,.9)}this.showScore(json)}getSVGcorrect(size,iscorrect,colorCorrect,colorError){if(iscorrect){return'<svg aria-hidden="true" class="svg-icon iconCheckmarkLg" width="'+size+'" height="'+size+'" viewBox="0 0 36 36"><path fill="'+(void 0!==colorCorrect?this.getColorHex(colorCorrect):"#398439")+'" d="m6 14 8 8L30 6v8L14 30l-8-8v-8z"></path></svg>'}return'<svg width="'+size+'" height="'+size+'" class="bi bi-x-lg" viewBox="0 0 18 18"> <path fill="'+(void 0!==colorError?this.getColorHex(colorError):"#398439")+'" d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 \n                1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/></svg>'}onServerAnswerMultichoice(json){let aCorrect=json.correct.split(",");for(let i=0;i<this.answersID.length;i++){let iscorrect,label=this.aItemLabel[i],checked=this.aItemAnswer[i].classList.contains("checked");if(aCorrect.includes(this.answersID[i]))iscorrect=!0;else{if(void 0===json.correct||!checked)continue;iscorrect=!1}let height=label.scrollHeight,width=label.scrollWidth-this.radioSize;label.style.left=parseInt(label.style.left)+this.radioSize+"px",label.style.width=width+"px",iscorrect&&(label.innerHTML="<b><u>"+label.innerHTML+"</u></b>"),this.autoResizeText(label,width,height,!0,this.minFontSize,this.maxFontSize,.9);let t=parseInt(this.aItemAnswer[i].style.top);this.createDiv(this.area,this.aItemCorrectX[i],t,this.radioSize,this.radioSize).innerHTML=this.getSVGcorrect(this.radioSize,iscorrect,this.colorScore,this.colorScore)}}disableInput(){if(void 0!==this.aItemAnswer)for(let i=0;i<this.aItemAnswer.length;i++)this.aItemAnswer[i].classList.add("disabled"),this.drawRadio(this.aItemAnswer[i],this.colorScore,this.colorDefinition)}sendFastJSON(){void 0!==this.timeoutFastJSON&&clearTimeout(this.timeoutFastJSON);let instance=this;this.timeoutFastJSON=setTimeout((function(){let xmlhttp=new XMLHttpRequest;xmlhttp.onreadystatechange=function(){this.timeoutFastJSON=void 0,4===this.readyState&&200===this.status&&instance.onServerFastJson(this.response)};let url=instance.url.substr(0,instance.url.length-8)+"state.php";xmlhttp.open("POST",url,!0);let data=new FormData;data.set("fastjson",instance.fastjson),data.set("type",instance.type),xmlhttp.send(data)}),1e3)}onClickHelp(){""!==this.helpUrl&&window.open(this.helpUrl,"_blank")}}}));

//# sourceMappingURL=mmogamequiz.min.js.map