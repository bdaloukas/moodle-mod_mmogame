define("mod_mmogame/mmogameui",["mod_mmogame/mmogame"],(function(MmoGame){return class extends MmoGame{isVertical;kindSound;buttonSound;colorBackground2;nickname;user;paletteid;avatarid;iconSize;padding;area;areaRect;edtNickname;mmogameid;constructor(){super(),this.isVertical=window.innerWidth<window.innerHeight,this.area=void 0}getMuteFile(){return 0===this.kindSound?"assets/sound-on-flat.png":"assets/sound-off-flat.png"}async playAudio(audioElement){if(0!==this.kindSound&&audioElement)try{await audioElement.play()}catch(error){this.showError("Playback failed:",error)}}createButtonSound(parent,left,top){this.buttonSound=this.createDOMElement("img",{parent:parent,classnames:"mmogame-button-sound",styles:{position:"absolute",left:`${left}px`,top:`${top}px`,width:`${this.iconSize}px`,height:`${this.iconSize}px`},attributes:{src:this.getMuteFile(),alt:this.getStringM("js_sound"),role:"button"}}),this.buttonSound.addEventListener("click",(()=>this.onClickSound(this.buttonSound)))}onClickSound(button){this.kindSound=(this.kindSound+1)%2,button.src=this.getMuteFile(),this.setOptions({kindSound:this.kindSound})}async gateOpen(mmogameid,pin,kinduser,user,url){this.url=url,this.mmogameid=mmogameid,this.pin=pin,this.kinduser=kinduser,this.user=user;const options=await this.getOptions();this.kindSound=[1,2].includes(options.kindSound)?options.kindSound:0;const isReady=options.nickname&&options.avatarid&&options.paletteid;"moodle"===kinduser&&isReady?await this.gatePlayGame(!1,options.nickname,options.paletteid,options.avatarid):"guid"===this.kinduser?(void 0===options.userGUID&&(options.userGUID=""),options.userGUID.length>=10&&isReady?(this.user=options.userGUID,this.gatePlayGame(!1,options.nickname,options.paletteid,options.avatarid)):this.gateCreateScreen()):this.gateCreateScreen()}gatePlayGame(save,nickname,paletteid,avatarid){let saveGuid=!1;if("guid"===this.kinduser&&""===this.user&&(this.user=crypto.randomUUID(),saveGuid=!0),save||saveGuid){let data;save?(data={user:this.user,nickname:nickname,avatarid:avatarid,paletteid:paletteid},saveGuid&&(data.userGUID=this.user)):data={userGUID:this.user},this.setOptions(data)}this.nickname=nickname,this.paletteid=paletteid,this.avatarid=avatarid,save?this.callGetAttempt({nickname:nickname,colorpaletteid:paletteid,avatarid:avatarid}):this.callGetAttempt()}gateCreateScreen(){this.gateCompute();let size,maxHeight=this.areaRect.height-5*this.padding-this.iconSize,maxWidth=this.areaRect.width;const labels=[`${this.getStringM("js_name")}: `,this.getStringM("js_code"),this.getStringM("js_palette")];this.fontSize=this.findbest(this.minFontSize,this.maxFontSize,(fontSize=>{if(size=this.gateComputeLabelSize(fontSize,labels),size[0]>=maxWidth)return 1;const heightColors=2*(maxHeight-4*fontSize)/5;if(0===Math.floor(heightColors/this.iconSize))return 1;const heightAvatars=3*(maxHeight-4*fontSize+heightColors)/5;return 3*size[1]+8*this.padding+heightColors+heightAvatars<maxHeight?-1:1})),this.gateCreateScreenDo(maxWidth,maxHeight)}gateCreateScreenDo(maxWidth,maxHeight){let top=this.gateCreateNickName(0,maxWidth)+this.padding;this.edtNickname.focus();const[lblPalette,btnPalette]=this.gateCreateLabelRefresh(top,this.getStringM("js_palette"),"mmogame-gate-palette-label","mmogame-gate-palette-refresh","assets/refresh.svg");top+=lblPalette.scrollHeight+this.padding;const topGridPalette=top;let gridHeightPalette=2*(maxHeight-topGridPalette-lblPalette.scrollHeight)/5;const countX=Math.floor((maxWidth-this.padding)/this.iconSize),countYpalette=Math.floor(gridHeightPalette/this.iconSize);gridHeightPalette=countYpalette*this.iconSize,top+=gridHeightPalette+this.padding;const[lblAvatars,btnAvatars]=this.gateCreateLabelRefresh(top,this.getStringM("js_avatars"),"mmogame-gate-avatars-label","mmogame-gate-avatars-refresh","assets/refresh.svg");top+=lblAvatars.scrollHeight+this.padding;const countYavatars=Math.floor(Math.floor(maxHeight-top-this.padding)/this.iconSize),gridHeightAvatars=countYavatars*this.iconSize;this.addEventListenerRefresh(btnPalette,topGridPalette,countX,countYpalette,top,countX,countYavatars,!0,!1),this.addEventListenerRefresh(btnAvatars,topGridPalette,countX,countYpalette,top,countX,countYavatars,!1,!0),this.gateSendGetColorsAvatars(0,topGridPalette,countX,countYpalette,0,top,countX,countYavatars,!0,!0),this.gateCreateSubmit(top+gridHeightAvatars+2*this.padding,maxWidth)}gateCreateNickName(top,maxWidth){const lblNickName=this.createDOMElement("label",{parent:this.area,classnames:"mmogame-gate-name-label",styles:{position:"absolute",fontSize:`${this.fontSize}px`,left:"0",top:`${top}px`,width:"0",color:this.getContrastingColor(this.colorBackground)}});lblNickName.innerHTML=this.getStringM("js_name")+": ",this.isVertical&&(top+=lblNickName.scrollHeight+this.padding);const leftEdit=this.isVertical?0:lblNickName.scrollWidth+this.padding,width=this.isVertical?maxWidth:maxWidth-2*this.padding;return this.edtNickname=this.createDOMElement("input",{parent:this.area,classnames:"mmogame-gate-name",styles:{position:"absolute",fontSize:`${this.fontSize}px`,left:`${leftEdit}px`,top:`${top}px`,width:width-leftEdit-this.padding+"px"}}),this.edtNickname.addEventListener("keyup",this.debounce((()=>this.gateUpdateSubmit()),300)),top+=this.padding+(this.isVertical?this.fontSize:Math.max(lblNickName.scrollHeight,this.fontSize))}gateCreateSubmit(top,maxWidth){this.btnSubmit=this.createDOMElement("img",{parent:this.area,classnames:"mmogame-button-gate-submit",styles:{position:"absolute",fontSize:`${this.fontSize}px`,left:(maxWidth-this.iconSize)/2+"px",top:`${top}px`,height:`${this.iconSize}px`,color:this.getContrastingColor(this.colorBackground),cursor:"pointer",visibility:"hidden"},attributes:{src:"assets/submit.svg"}}),this.btnSubmit.addEventListener("click",(()=>{this.gatePlayGame(!0,this.edtNickname.value,this.paletteid,this.avatarid)}))}gateComputeLabelSize(fontSize,aLabel){const instance=this;let maxWidth=0,maxHeight=0;for(let i=0;i<aLabel.length;i++){const label=document.createElement("label");label.style.position="absolute",label.innerHTML=aLabel[i],label.style.whiteSpace="nowrap",label.style.font="FontAwesome",label.style.fontSize=fontSize+"px",label.style.width="0px",label.style.height="0px",instance.area.appendChild(label),label.scrollWidth>maxWidth&&(maxWidth=label.scrollWidth),label.scrollHeight>maxHeight&&(maxHeight=label.scrollHeight),instance.area.removeChild(label)}return[maxWidth,maxHeight]}gateShowAvatars(left,top,countX,countY,avatarids,avatars){const instance=this;if(!avatars||0===avatars.length)return;document.querySelectorAll(".mmogame-avatar").forEach((element=>element.remove()));const fragment=document.createDocumentFragment();instance.avatar=void 0;const count=avatars.length;let leftOriginal=left,w=Math.round(this.padding/2)+"px";for(let i=0;i<count;i++){let avatarImagePath="assets/avatars/"+avatars[i],btn=instance.createCenterImageButton(fragment,left,top,instance.iconSize-instance.padding,instance.iconSize-instance.padding,"mmogame-avatar",avatarImagePath);btn.classList.add("mmogame-avatar");let id=avatarids[i];btn.addEventListener("click",(()=>{instance.gateUpdateAvatar(btn,id,w)})),left+=instance.iconSize,(i+1)%countX==0&&(top+=instance.iconSize,left=leftOriginal)}instance.area.appendChild(fragment)}gateSendGetColorsAvatars(leftPalette,topPalette,countXpalette,countYpalette,leftAvatars,topAvatars,countXavatars,countYavatars){let updatePalette=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],updateAvatars=!(arguments.length>9&&void 0!==arguments[9])||arguments[9];const instance=this;require(["core/ajax"],(Ajax=>{let params={mmogameid:instance.mmogameid,kinduser:instance.kinduser,user:instance.user,avatars:updateAvatars?countXavatars*countYavatars:0,colorpalettes:updatePalette?countXpalette*countYpalette:0};Ajax.call([{methodname:"mod_mmogame_get_assets",args:params}])[0].done((_ref=>{let{avatarids:avatarids,avatars:avatars,colorpaletteids:colorpaletteids,colorpalettes:colorpalettes}=_ref;updatePalette&&instance.gateShowColorPalettes(leftPalette,topPalette,countXpalette,countYpalette,colorpaletteids,colorpalettes),updateAvatars&&instance.gateShowAvatars(leftAvatars,topAvatars,countXavatars,countYavatars,avatarids,avatars)})).fail((error=>error))}))}gateShowColorPalettes(left,top,countX,countY,colorpaletteids,colorpalettes){const instance=this;let i=0;const count=colorpalettes.length;this.canvasColor=void 0;const canvasSize=instance.iconSize-3*instance.padding/2,parsedPalettes=colorpalettes.map((palette=>palette.split(",").map((value=>parseInt(value,10)||0)))),fragment=document.createDocumentFragment();for(let iy=0;iy<countY;iy++)for(let ix=0;ix<countX;ix++){if(i>=count||!parsedPalettes[i]||!colorpaletteids[i]){i++;continue}let canvas=document.createElement("canvas");canvas.style.position="absolute",canvas.style.left=`${left+ix*instance.iconSize}px`,canvas.style.top=`${top+iy*instance.iconSize}px`,canvas.width=canvasSize,canvas.height=canvasSize,canvas.style.cursor="pointer",canvas.classList.add("mmogame_color"),fragment.appendChild(canvas),instance.showColorPalette(canvas,parsedPalettes[i]);let id=colorpaletteids[i];canvas.addEventListener("click",(()=>{instance.gateUpdateColorPalette(canvas,id)})),i++}instance.area.appendChild(fragment)}gateUpdateColorPalette(canvas,id){void 0!==this.canvasColor&&(this.canvasColor.style.borderStyle="none"),this.canvasColor=canvas;let w=Math.round(this.padding/2)+"px";Object.assign(canvas.style,{borderStyle:"outset",borderLeftWidth:w,borderTopWidth:w,borderRightWidth:w,borderBottomWidth:w}),this.paletteid=id,this.gateUpdateSubmit()}gateUpdateAvatar(avatar,id,w){const instance=this;void 0!==instance.avatar&&(instance.avatar.style.borderStyle="none"),instance.avatar=avatar,avatar.style.borderStyle="outset",avatar.style.borderLeftWidth=w,avatar.style.borderTopWidth=w,avatar.style.borderRightWidth=w,avatar.style.borderBottomWidth=w,instance.avatarid=id,instance.gateUpdateSubmit()}gateUpdateSubmit(){const hasAvatar=void 0!==this.avatarid,hasPalette=void 0!==this.paletteid,hasNickname=this.edtNickname?.value?.length>0;this.btnSubmit.style.visibility=hasAvatar&&hasPalette&&hasNickname?"visible":"hidden"}gateComputeSizes(){this.computeSizes(),this.iconSize=Math.round(.8*this.iconSize),this.padding=Math.round(.8*this.padding)}gateCreateLabelRefresh(top,title,classLabel,classButton,src){const label=this.createDOMElement("label",{parent:this.area,classnames:classLabel,styles:{position:"absolute",font:"FontAwesome",fontSize:`${this.fontSize}px`,width:"0px",whiteSpace:"nowrap",color:this.getContrastingColor(this.colorBackground),top:`${top}px`,left:"0px"}});return label.innerHTML=title,[label,this.createDOMElement("img",{parent:this.area,classnames:classButton,styles:{position:"absolute",fontSize:`${this.fontSize}px`,left:`${label.scrollWidth+this.padding}px`,top:`${top}px`,height:`${label.scrollHeight}px`,color:this.getContrastingColor(this.colorBackground),cursor:"pointer"},attributes:{src:src}})]}addEventListenerRefresh(btn,topPalette,countXpalette,countYpalette,topAvatars,countXavatars,countYavatars,updateColors,updateAvatars){btn.addEventListener("click",(()=>{Array.from(this.area.getElementsByClassName("mmogame-color")).forEach((element=>element.remove())),this.gateSendGetColorsAvatars(0,topPalette,countXpalette,countYpalette,0,topAvatars,countXavatars,countYavatars,updateColors,updateAvatars)}))}createArea(top,bottomSpace){void 0!==this.area&&this.body.removeChild(this.area),this.area=this.createDOMElement("div",{parent:this.body,classnames:"mmogame-area",styles:{position:"absolute",left:`${this.padding}px`,top:`${top}px`,right:`${this.padding}px`,bottom:`${this.padding+bottomSpace}px`,overflow:"hidden"}}),this.areaRect={left:this.padding,top:top,width:this.area.offsetWidth,height:this.area.offsetHeight}}createDivMessage(classnames,message){const instance=this;void 0!==instance.area&&(instance.body.removeChild(instance.area),instance.area=void 0),void 0!==instance.divMessageHelp&&(instance.body.removeChild(instance.divMessageHelp),instance.divMessageHelp=void 0);let left=instance.padding,top=void 0!==instance.areaRect?instance.areaRect.top:0,width=window.innerWidth-2*instance.padding,height=window.innerHeight-instance.padding-top;instance.createDivMessageDo(classnames,left,top,width,height,message,height),instance.divMessage.style.top=(height-instance.divMessage.scrollHeight)/2+"px"}createNicknameAvatar(parent,prefixclassname,left,topNickname,widthNickname,heightNickname,topAvatar,widthAvatar){const nickname=this.createDOMElement("div",{parent:parent,classname:`${prefixclassname}-nickname`,styles:{position:"absolute",left:`${left}px`,top:`${topNickname}px`,width:`${widthNickname}px`}});let leftAvatar=Math.round(left+this.iconSize/2);return[nickname,this.createDOMElement("img",{classname:`${prefixclassname}-avatar`,parent:this.body,styles:{position:"absolute",left:`${leftAvatar}px`,top:`${topAvatar}px`,height:`${widthAvatar}px`,maxWidth:`${widthAvatar}px`,transform:"translateX(-50%)"}})]}createDivMessageStart(message){const instance=this;void 0!==instance.area&&(instance.body.removeChild(instance.area),instance.area=void 0);let left=instance.padding,top=instance.areaRect.top,width=window.innerWidth-2*instance.padding,height=window.innerHeight-instance.padding-top,height1=height/8;if(instance.createDivMessageDo("mmogame-message-start",left,top,width,height,message,height1),top+=(height1-instance.divMessage.scrollHeight)/2,instance.divMessage.style.top=top+"px",void 0===instance.divMessageHelp){let div=document.createElement("div");div.style.position="absolute",div.style.left=left+"px",div.style.textAlign="left",div.style.width=width-2*this.padding+"px",div.style.paddingLeft=this.padding+"px",div.style.paddingRight=this.padding+"px",div.style.color=instance.getContrastingColor(this.colorBackground2);let top=instance.iconSize+3*instance.padding+height1;div.style.top=top+instance.padding+"px",div.style.height=height-height1+"px",instance.divMessageHelp=div,instance.body.appendChild(instance.divMessageHelp),instance.showHelpScreen(div,width-2*instance.padding,height-height1)}}callGetAttempt(){let extraparams=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;require(["core/ajax"],(Ajax=>{let params={mmogameid:this.mmogameid,kinduser:this.kinduser,user:this.user,nickname:null,colorpaletteid:null,avatarid:null};void 0!==extraparams&&(params={...params,...extraparams}),Ajax.call([{methodname:"mmogametype_quiz_get_attempt",args:params}])[0].done((response=>{void 0===this.iconSize&&this.openGame(),this.processGetAttempt(JSON.parse(response))})).fail((error=>(this.createDivMessage("mmogame-error",error.message),error)))}))}createDivMessageDo(classnames,left,top,width,height,message,heightmessage){if(void 0===this.divMessageBackground){let div=this.createDiv(this.body,classnames,left,top,width,height);div.style.background=this.getColorHex(this.colorBackground2),this.divMessageBackground=div}if(void 0===this.divMessage){let div=document.createElement("div");div.style.position="absolute",div.style.left=left+"px",div.style.textAlign="center",div.style.width=width-2*this.padding+"px",div.style.paddingLeft=this.padding+"px",div.style.paddingRight=this.padding+"px",div.style.background=this.getColorHex(this.colorBackground2),div.style.color=this.getContrastingColor(this.colorBackground2),this.divMessage=div}this.divMessage.innerHTML=message,this.body.appendChild(this.divMessage),this.autoResizeText(this.divMessage,width,heightmessage,!1,this.minFontSize,this.maxFontSize,.5)}setColors(colors){super.setColors(colors),this.colorBackground2=colors[1]}showError(name,error){const message=error?.message||"An unknown error occurred.";this.createDivMessage("mmogame-error",message)}createButtonHelp(parent,left,top){return this.createDOMElement("img",{parent:parent,classnames:"mmogame-button-help",styles:{position:"absolute",left:`${left}px`,top:`${top}px`,width:`${this.iconSize}px`,height:`${this.iconSize}px`},attributes:{src:"assets/help.svg",alt:this.getStringM("js_help"),role:"button"}})}onClickHelp(){this.createDivMessageStart("test")}gateCompute(){this.minFontSize*=2,this.maxFontSize*=2,this.gateComputeSizes(),this.createArea(this.padding)}}}));

//# sourceMappingURL=mmogameui.min.js.map