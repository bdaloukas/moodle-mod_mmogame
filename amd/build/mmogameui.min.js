define("mod_mmogame/mmogameui",["mod_mmogame/mmogame"],(function(MmoGame){return class extends MmoGame{isVertical;kindSound;buttonSound;colorBackground2;nickname;user;paletteid;avatarid;iconSize;padding;area;areaRect;edtNickname;mmogameid;divMessage;divMessageHelp;divMessageBackground;constructor(){super(),this.isVertical=window.innerWidth<window.innerHeight,this.area=void 0}getMuteFile(){return 0===this.kindSound?"assets/sound-on-flat.png":"assets/sound-off-flat.png"}async playAudio(audioElement){if(0!==this.kindSound&&audioElement)try{await audioElement.play()}catch(error){this.showError("Playback failed:",error)}}createButtonSound(parent,left,top){this.buttonSound=this.createDOMElement("img",{parent:parent,classnames:"mmogame-button-sound",styles:{position:"absolute",left:`${left}px`,top:`${top}px`,width:`${this.iconSize}px`,height:`${this.iconSize}px`},attributes:{src:this.getMuteFile(),alt:this.getStringM("js_sound"),role:"button"}}),this.buttonSound.addEventListener("click",(()=>this.onClickSound(this.buttonSound)))}onClickSound(button){this.kindSound=(this.kindSound+1)%2,button.src=this.getMuteFile(),this.setOption("kindSound",{value:this.kindSound})}async gateOpen(mmogameid,pin,kinduser,user,url){if(this.url=url,this.mmogameid=mmogameid,this.pin=pin,this.kinduser=kinduser,this.user=user,"guid"===this.kinduser){const option=await this.getOption("guid"+mmogameid);null===option?(this.user=crypto.randomUUID(),this.setOption("guid"+mmogameid,{value:this.user})):this.user=option.value}await this.callGetAttempt()}gateCreateScreen(){this.gateCompute();let size,maxHeight=this.areaRect.height-5*this.padding-this.iconSize,maxWidth=this.areaRect.width;const labels=[`${this.getStringM("js_name")}: `,this.getStringM("js_code"),this.getStringM("js_palette")];this.fontSize=this.findbest(this.minFontSize,this.maxFontSize,(fontSize=>{if(size=this.gateComputeLabelSize(fontSize,labels),size[0]>=maxWidth)return 1;const heightColors=2*(maxHeight-4*fontSize)/5;if(0===Math.floor(heightColors/this.iconSize))return 1;const heightAvatars=3*(maxHeight-4*fontSize+heightColors)/5;return 3*size[1]+8*this.padding+heightColors+heightAvatars<maxHeight?-1:1})),this.gateCreateScreenDo(maxWidth,maxHeight)}gateCreateScreenDo(maxWidth,maxHeight){let top=this.gateCreateNickname(0,maxWidth)+this.padding;this.edtNickname.focus();const[lblPalette,btnPalette]=this.gateCreateLabelRefresh(top,this.getStringM("js_palette"),"mmogame-gate-palette-label","mmogame-gate-palette-refresh","assets/refresh.svg");top+=lblPalette.scrollHeight+this.padding;const topGridPalette=top;let gridHeightPalette=2*(maxHeight-topGridPalette-lblPalette.scrollHeight)/5;const countX=Math.floor((maxWidth-this.padding)/this.iconSize),countYpalette=Math.floor(gridHeightPalette/this.iconSize);gridHeightPalette=countYpalette*this.iconSize,top+=gridHeightPalette+this.padding;const[lblAvatars,btnAvatars]=this.gateCreateLabelRefresh(top,this.getStringM("js_avatars"),"mmogame-gate-avatars-label","mmogame-gate-avatars-refresh","assets/refresh.svg");top+=lblAvatars.scrollHeight+this.padding;const countYavatars=Math.floor(Math.floor(maxHeight-top-this.padding)/this.iconSize),gridHeightAvatars=countYavatars*this.iconSize;this.addEventListenerRefresh(btnPalette,topGridPalette,countX,countYpalette,top,countX,countYavatars,!0,!1),this.addEventListenerRefresh(btnAvatars,topGridPalette,countX,countYpalette,top,countX,countYavatars,!1,!0),this.gateSendGetColorsAvatars(0,topGridPalette,countX,countYpalette,0,top,countX,countYavatars,!0,!0),this.gateCreateSubmit(top+gridHeightAvatars+2*this.padding,maxWidth)}gateCreateNickname(top,maxWidth){const lblNickname=this.createDOMElement("label",{parent:this.area,classnames:"mmogame-gate-name-label",styles:{position:"absolute",fontSize:`${this.fontSize}px`,left:"0",top:`${top}px`,width:"0",color:this.getContrastingColor(this.colorBackground)}});lblNickname.innerHTML=this.getStringM("js_name")+": ",this.isVertical&&(top+=lblNickname.scrollHeight+this.padding);const leftEdit=this.isVertical?0:lblNickname.scrollWidth+this.padding,width=this.isVertical?maxWidth:maxWidth-2*this.padding;return this.edtNickname=this.createDOMElement("input",{parent:this.area,classnames:"mmogame-gate-name",styles:{position:"absolute",fontSize:`${this.fontSize}px`,left:`${leftEdit}px`,top:`${top}px`,width:width-leftEdit-this.padding+"px"}}),this.edtNickname.addEventListener("keyup",this.debounce((()=>this.gateUpdateSubmit()),300)),top+=this.padding+(this.isVertical?this.fontSize:Math.max(lblNickname.scrollHeight,this.fontSize))}gateCreateSubmit(top,maxWidth){this.btnSubmit=this.createDOMElement("img",{parent:this.area,classnames:"mmogame-button-gate-submit",styles:{position:"absolute",fontSize:`${this.fontSize}px`,left:(maxWidth-this.iconSize)/2+"px",top:`${top}px`,height:`${this.iconSize}px`,color:this.getContrastingColor(this.colorBackground),cursor:"pointer",visibility:"hidden"},attributes:{src:"assets/submit.svg"}}),this.btnSubmit.addEventListener("click",(()=>{this.callGetAttempt({nickname:this.edtNickname.value,colorpaletteid:this.paletteid,avatarid:this.avatarid})}))}gateComputeLabelSize(fontSize,aLabel){let maxWidth=0,maxHeight=0;for(let i=0;i<aLabel.length;i++){const label=document.createElement("label");label.style.position="absolute",label.innerHTML=aLabel[i],label.style.whiteSpace="nowrap",label.style.font="FontAwesome",label.style.fontSize=fontSize+"px",label.style.width="0px",label.style.height="0px",this.area.appendChild(label),label.scrollWidth>maxWidth&&(maxWidth=label.scrollWidth),label.scrollHeight>maxHeight&&(maxHeight=label.scrollHeight),this.area.removeChild(label)}return[maxWidth,maxHeight]}gateShowAvatars(left,top,countX,countY,avatarids,avatars){if(!avatars||0===avatars.length)return;document.querySelectorAll(".mmogame-avatar").forEach((element=>element.remove()));const fragment=document.createDocumentFragment();this.avatar=void 0;const count=avatars.length;let leftOriginal=left,w=Math.round(this.padding/2)+"px";for(let i=0;i<count;i++){let avatarImagePath="assets/avatars/"+avatars[i],btn=this.createCenterImageButton(fragment,left,top,this.iconSize-this.padding,this.iconSize-this.padding,"mmogame-avatar",avatarImagePath);btn.classList.add("mmogame-avatar");let id=avatarids[i];btn.addEventListener("click",(()=>{this.gateUpdateAvatar(btn,id,w)})),left+=this.iconSize,(i+1)%countX==0&&(top+=this.iconSize,left=leftOriginal)}this.area.appendChild(fragment)}gateSendGetColorsAvatars(leftPalette,topPalette,countXpalette,countYpalette,leftAvatars,topAvatars,countXavatars,countYavatars){let updatePalette=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],updateAvatars=!(arguments.length>9&&void 0!==arguments[9])||arguments[9];require(["core/ajax"],(Ajax=>{let params={mmogameid:this.mmogameid,kinduser:this.kinduser,user:this.user,avatars:updateAvatars?countXavatars*countYavatars:0,colorpalettes:updatePalette?countXpalette*countYpalette:0};Ajax.call([{methodname:"mod_mmogame_get_assets",args:params}])[0].done((_ref=>{let{avatarids:avatarids,avatars:avatars,colorpaletteids:colorpaletteids,colorpalettes:colorpalettes}=_ref;updatePalette&&this.gateShowColorPalettes(leftPalette,topPalette,countXpalette,countYpalette,colorpaletteids,colorpalettes),updateAvatars&&this.gateShowAvatars(leftAvatars,topAvatars,countXavatars,countYavatars,avatarids,avatars)})).fail((error=>error))}))}gateShowColorPalettes(left,top,countX,countY,colorpaletteids,colorpalettes){let i=0;const count=colorpalettes.length;this.canvasColor=void 0;const canvasSize=this.iconSize-3*this.padding/2,parsedPalettes=colorpalettes.map((palette=>palette.split(",").map((value=>parseInt(value,10)||0)))),fragment=document.createDocumentFragment();for(let iy=0;iy<countY;iy++)for(let ix=0;ix<countX;ix++){if(i>=count||!parsedPalettes[i]||!colorpaletteids[i]){i++;continue}let canvas=document.createElement("canvas");canvas.style.position="absolute",canvas.style.left=`${left+ix*this.iconSize}px`,canvas.style.top=`${top+iy*this.iconSize}px`,canvas.width=canvasSize,canvas.height=canvasSize,canvas.style.cursor="pointer",canvas.classList.add("mmogame_color"),fragment.appendChild(canvas),this.showColorPalette(canvas,parsedPalettes[i]);let id=colorpaletteids[i];canvas.addEventListener("click",(()=>{this.gateUpdateColorPalette(canvas,id)})),i++}this.area.appendChild(fragment)}gateUpdateColorPalette(canvas,id){void 0!==this.canvasColor&&(this.canvasColor.style.borderStyle="none"),this.canvasColor=canvas;let w=Math.round(this.padding/2)+"px";Object.assign(canvas.style,{borderStyle:"outset",borderLeftWidth:w,borderTopWidth:w,borderRightWidth:w,borderBottomWidth:w}),this.paletteid=id,this.gateUpdateSubmit()}gateUpdateAvatar(avatar,id,w){void 0!==this.avatar&&(this.avatar.style.borderStyle="none"),this.avatar=avatar,avatar.style.borderStyle="outset",avatar.style.borderLeftWidth=w,avatar.style.borderTopWidth=w,avatar.style.borderRightWidth=w,avatar.style.borderBottomWidth=w,this.avatarid=id,this.gateUpdateSubmit()}gateUpdateSubmit(){var _this$edtNickname,_this$edtNickname$val;const hasAvatar=void 0!==this.avatarid,hasPalette=void 0!==this.paletteid,hasNickname=(null===(_this$edtNickname=this.edtNickname)||void 0===_this$edtNickname||null===(_this$edtNickname$val=_this$edtNickname.value)||void 0===_this$edtNickname$val?void 0:_this$edtNickname$val.length)>0;this.btnSubmit.style.visibility=hasAvatar&&hasPalette&&hasNickname?"visible":"hidden"}gateComputeSizes(){this.computeSizes(),this.iconSize=Math.round(.8*this.iconSize),this.padding=Math.round(.8*this.padding)}gateCreateLabelRefresh(top,title,classLabel,classButton,src){const label=this.createDOMElement("label",{parent:this.area,classnames:classLabel,styles:{position:"absolute",font:"FontAwesome",fontSize:`${this.fontSize}px`,width:"0px",whiteSpace:"nowrap",color:this.getContrastingColor(this.colorBackground),top:`${top}px`,left:"0px"}});return label.innerHTML=title,[label,this.createDOMElement("img",{parent:this.area,classnames:classButton,styles:{position:"absolute",fontSize:`${this.fontSize}px`,left:`${label.scrollWidth+this.padding}px`,top:`${top}px`,height:`${label.scrollHeight}px`,color:this.getContrastingColor(this.colorBackground),cursor:"pointer"},attributes:{src:src}})]}addEventListenerRefresh(btn,topPalette,countXpalette,countYpalette,topAvatars,countXavatars,countYavatars,updateColors,updateAvatars){btn.addEventListener("click",(()=>{Array.from(this.area.getElementsByClassName("mmogame-color")).forEach((element=>element.remove())),this.gateSendGetColorsAvatars(0,topPalette,countXpalette,countYpalette,0,topAvatars,countXavatars,countYavatars,updateColors,updateAvatars)}))}createArea(top,bottomSpace){void 0!==this.area&&this.body.removeChild(this.area),this.area=this.createDOMElement("div",{parent:this.body,classnames:"mmogame-area",styles:{position:"absolute",left:`${this.padding}px`,top:`${top}px`,right:`${this.padding}px`,bottom:`${this.padding+bottomSpace}px`,overflow:"hidden"}}),this.areaRect={left:this.padding,top:top,width:this.area.offsetWidth,height:this.area.offsetHeight,bottom:bottomSpace}}removeAreaChildren(){if(void 0!==this.area)for(;this.area.firstChild;)this.area.removeChild(this.area.firstChild)}createDivMessage(classnames,message){void 0!==this.area&&(this.body.removeChild(this.area),this.area=void 0),void 0!==this.divMessageHelp&&(this.body.removeChild(this.divMessageHelp),this.divMessageHelp=void 0);let left=this.padding,top=void 0!==this.areaRect?this.areaRect.top:0,width=window.innerWidth-2*this.padding,height=window.innerHeight-this.padding-top;this.createDivMessageDo(classnames,left,top,width,height,message,height),this.divMessage.style.top=(height-this.divMessage.scrollHeight)/2+"px"}createNicknameAvatar(parent,prefixclassname,left,topNickname,widthNickname,heightNickname,topAvatar,widthAvatar){const nickname=this.createDOMElement("div",{parent:parent,classname:`${prefixclassname}-nickname`,styles:{position:"absolute",left:`${left}px`,top:`${topNickname}px`,width:`${widthNickname}px`}});let leftAvatar=Math.round(left+this.iconSize/2);return[nickname,this.createDOMElement("img",{classname:`${prefixclassname}-avatar`,parent:this.body,styles:{position:"absolute",left:`${leftAvatar}px`,top:`${topAvatar}px`,height:`${widthAvatar}px`,maxWidth:`${widthAvatar}px`,transform:"translateX(-50%)"}})]}createDivMessageStart(message){if(void 0!==this.divMessageHelp)return;void 0!==this.area&&(this.body.removeChild(this.area),this.area=void 0);let left=this.padding,top=this.areaRect.top,width=window.innerWidth-2*this.padding,height=window.innerHeight-this.padding-top,height1=height/8;this.createDivMessageDo("mmogame-message-start",left,top,width,height,message,height1),top+=(height1-this.divMessage.scrollHeight)/2,this.divMessage.style.top=top+"px";let div=document.createElement("div");div.style.position="absolute",div.style.left=left+"px",div.style.textAlign="left",div.style.width=width-2*this.padding+"px",div.style.paddingLeft=this.padding+"px",div.style.paddingRight=this.padding+"px",div.style.color=this.getContrastingColor(this.colorBackground2),top=this.iconSize+3*this.padding+height1,div.style.top=top+this.padding+"px",div.style.height=height-height1+"px",this.divMessageHelp=div,this.body.appendChild(this.divMessageHelp),this.showHelpScreen(div,width-2*this.padding,height-height1)}async callGetAttempt(){let extraparams=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;const option=await this.getOption("kindSound");this.kindSound=null!==option?option.value:1,require(["core/ajax"],(Ajax=>{let params={mmogameid:this.mmogameid,kinduser:this.kinduser,user:this.user,nickname:null,colorpaletteid:null,avatarid:null,subcommand:""};void 0!==extraparams&&(params={...params,...extraparams}),Ajax.call([{methodname:"mmogametype_quiz_get_attempt",args:params}])[0].done((response=>{const json=JSON.parse(response);"no_user"!==json.errorcode?(void 0!==this.area&&(this.body.removeChild(this.area),this.area=void 0),void 0===this.iconSize&&this.openGame(),this.processGetAttempt(json)):this.gateCreateScreen()})).fail((error=>(this.createDivMessage("mmogame-error",error.message),error)))}))}createDivMessageDo(classnames,left,top,width,height,message,heightmessage){if(void 0===this.divMessageBackground){let div=this.createDiv(this.body,classnames,left,top,width,height);div.style.background=this.getColorHex(this.colorBackground2),this.divMessageBackground=div}if(void 0===this.divMessage){let div=document.createElement("div");div.style.position="absolute",div.style.left=left+"px",div.style.textAlign="center",div.style.width=width-2*this.padding+"px",div.style.paddingLeft=this.padding+"px",div.style.paddingRight=this.padding+"px",div.style.background=this.getColorHex(this.colorBackground2),div.style.color=this.getContrastingColor(this.colorBackground2),this.divMessage=div}this.divMessage.innerHTML=message,this.body.appendChild(this.divMessage),this.autoResizeText(this.divMessage,width,heightmessage,!1,this.minFontSize,this.maxFontSize,.5)}removeMessageDivs(){void 0!==this.divMessage&&(this.body.removeChild(this.divMessage),this.divMessage=void 0),void 0!==this.divMessageHelp&&(this.body.removeChild(this.divMessageHelp),this.divMessageHelp=void 0),void 0!==this.divMessageBackground&&(this.body.removeChild(this.divMessageBackground),this.divMessageBackground=void 0)}setColors(colors){super.setColors(colors),this.colorBackground2=colors[1]}showError(name,error){const message=(null==error?void 0:error.message)||"An unknown error occurred.";this.createDivMessage("mmogame-error",message)}createButtonHelp(parent,left,top){return this.createDOMElement("img",{parent:parent,classnames:"mmogame-button-help",styles:{position:"absolute",left:`${left}px`,top:`${top}px`,width:`${this.iconSize}px`,height:`${this.iconSize}px`},attributes:{src:"assets/help.svg",alt:this.getStringM("js_help"),role:"button"}})}onClickHelp(){void 0===this.divMessageHelp?this.createDivMessageStart("Help"):(this.removeMessageDivs(),this.callGetAttempt())}gateCompute(){this.minFontSize*=2,this.maxFontSize*=2,this.gateComputeSizes(),this.createArea(this.padding,0)}removeDivMessage(){void 0!==this.divMessage&&(this.body.removeChild(this.divMessage),this.divMessage=void 0),void 0!==this.divMessageHelp&&(this.body.removeChild(this.divMessageHelp),this.divMessageHelp=void 0),void 0!==this.divMessageBackground&&(this.divMessageBackground.remove(),this.divMessageBackground=void 0)}}}));

//# sourceMappingURL=mmogameui.min.js.map